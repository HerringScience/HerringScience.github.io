---
title: ""
output:
  rmdformats::html_clean:
    highlight: kate
---

```{r setup, include=FALSE}
## Global options
rm(list = ls())
#Change these options
surv = "SB"
surv2 = "Scots Bay"
surv.date = "2023-08-14 20:30"
surv.no = "7"
Allocation = "100" #set to "0" for a non-fishing survey
SIAllocation = "75" #Seal Island allocation for GB-only
Tagging = "Morning Star, Sealife II, Lady Janice, Fundy Monarch, Tasha Marie, and Lady Melissa" #list vessel names in a single quote string (e.g. "Lady Melissa and Sealife II")

#Set vessels below
vessels = 9
EVessel = "Brunswick Provider" #Set NA for GB or excluding box
NVessel = "Fundy Monarch" #Set NA for GB or excluding box
PlanktonVessel = "Lady Janice"

#Main box only (e.g. if vessels = 9 with both SB boxes, should have 1 Evessel, 1 Nvessel, and 7 Vessels below)
V1 = "Morning Star"
V2 = PlanktonVessel
V3 = "Leroy and Barry"
V4 = "Sealife II"
V5 = "Lady Melissa"
V6 = "Canada 100"
V7 = "Tasha Marie"
V8 = NA
V9 = NA

knitr::opts_knit$set(root.dir = paste0("C:/Users/", Sys.info()[7],"/Documents/GitHub/HerringScience.github.io/"))
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, fig.align='center')
```

```{r Data Import, include=FALSE}
#Import all packages and data
library(cli)
library(lubridate)
library(reprex)
library(tidyverse)
library(geosphere)
library(reshape2)
library(moderndive)
library(skimr)
library(ggridges)
library(weathercan)
library(GGally)
library(psych)
library(raster)
library(PBSmapping)
library(rgeos)
library(knitr)
library(kableExtra)
library(grid)
library(gridExtra)
library(cowplot)
library(measurements)

#Parse date time
surv.date = as.POSIXlt(surv.date, format="%Y-%m-%d %H:%M")
StartTime = substr(surv.date, 12,16)
StartDate = substr(surv.date, 1,10)
year = substr(surv.date, 1,4)

#Create Plan by combining main box with any extra boxes
vessels2 = ifelse(is.na(EVessel) & is.na(NVessel), vessels,
           ifelse(!is.na(EVessel) & is.na(NVessel), vessels-1,
           ifelse(!is.na(EVessel) & !is.na(NVessel), vessels-2,
           NA)))

Main = read_csv(paste0("C:/Users/", Sys.info()[7], "/Documents/GitHub/HerringScience.github.io/Surveys/Survey Lines/", surv, "/V", vessels2, ".csv"))

if(!is.na(NVessel)){North = read_csv(paste0("C:/Users/", Sys.info()[7], "/Documents/GitHub/HerringScience.github.io/Surveys/Survey Lines/", surv, "/North_Box.csv"))}
if(!is.na(EVessel)){East = read_csv(paste0("C:/Users/", Sys.info()[7], "/Documents/GitHub/HerringScience.github.io/Surveys/Survey Lines/", surv, "/East_Box.csv"))}

if(!is.na(NVessel) & is.na(EVessel)){Plan = full_join(Main, North)}
if(is.na(NVessel) & !is.na(EVessel)){Plan = full_join(Main, East)}
if(!is.na(NVessel) & !is.na(EVessel)){
  Plan = full_join(Main, North)
  Plan = full_join(Plan, East)}

#Add vessel names to Plan
Plan = Plan %>% 
  mutate(Vessel = replace(Vessel, Vessel == "V1", V1)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "V2", V2)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "V3", V3)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "V4", V4)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "V5", V5)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "V6", V6)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "V7", V7)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "V8", V8)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "V9", V9)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "NVessel", NVessel)) %>%
  mutate(Vessel = replace(Vessel, Vessel == "EVessel", EVessel))

#Short-hand names and save for Update Data script usage
Plan2 = Plan %>%
  mutate(Vessel = replace(Vessel, Vessel == "Leroy and Barry", "LB")) %>%
  mutate(Vessel = replace(Vessel, Vessel == "Morning Star", "MS")) %>%
  mutate(Vessel = replace(Vessel, Vessel == "Canada 100", "C1")) %>%
  mutate(Vessel = replace(Vessel, Vessel == "Fundy Monarch", "FM")) %>%
  mutate(Vessel = replace(Vessel, Vessel == "Brunswick Provider", "BP")) %>%
  mutate(Vessel = replace(Vessel, Vessel == "Lady Melissa", "LM")) %>%
  mutate(Vessel = replace(Vessel, Vessel == "Sealife II" | Vessel == "Sealife", "SL")) %>%
  mutate(Vessel = replace(Vessel, Vessel == "Lady Janice" | Vessel == "Lady Janice II", "LJ")) %>%
  mutate(Vessel = replace(Vessel, Vessel == "Tasha Marie", "TM"))
write_csv(x=Plan2, file=paste0("C:/Users/", Sys.info()[7],"/Documents/GitHub/HerringScience.github.io/Surveys/", year, "/", surv, surv.no, "/survey plan.csv"))

#Land Data
setwd(paste0("C:/Users/", Sys.info()[7], "/Documents/GitHub/HerringScience.github.io/"))
can<-getData('GADM', country="CAN", level=1)
us = getData('GADM', country = "USA", level = 1)
can1 = rbind(can,us)
NBNS <- can1[can1@data$NAME_1%in%c("New Brunswick","Nova Scotia","Prince Edward Island","Newfoundland and Labrador","Québec", "Maine"),]

# Proper coordinates for German Bank
GBMap <- as(extent(-66.5, -65.5, 43, 44), "SpatialPolygons")
proj4string(GBMap) <- CRS(proj4string(NBNS))
GBout <- gIntersection(NBNS, GBMap, byid=TRUE)

# Proper coordinates for Scots Bay
SBMap <- as(extent(-65.5, -64.5, 45, 45.5), "SpatialPolygons")
proj4string(SBMap) <- CRS(proj4string(NBNS))
SBout <- gIntersection(NBNS, SBMap, byid=TRUE)

#Make CTD Cast Box (GB or SB)
a = c("4334.320", "4333.600", "4333.600", "4334.320")
b = c("6622.080", "6622.080", "6621.000", "6621.000")
c = c("4503.432", "4503.000", "4503.000", "4503.432")
d = c("6513.048", "6513.048", "6512.000", "6512.000")

if(surv == "SB") {
  CTDBox = data.frame(c,d)
  names(CTDBox) = c('Lat', 'Lon')
}

if(surv == "GB") {
  CTDBox = data.frame(a,b)
  names(CTDBox) = c('Lat', 'Lon')
}

#Make Tow Box (SB only)
a = c("4501.800", "4504.200", "4506.780", "4504.500")
b = c("6515.300", "6506.600", "6506.600", "6515.300")
TowBox = data.frame(a,b)
names(TowBox) = c('Lat', 'Lon')
```

```{r Box Import}
#Import All Boxes
setwd(paste0("C:/Users/", Sys.info()[7], "/Documents/GitHub/HerringScience.github.io/Box Coordinates/"))
boxes = read.csv("surveyBoxes.csv")

# Scots Bay plankton and CTD box
SBplankton=boxes[which(boxes$Box == "SBPlanktonBox"), ]
SBCTD=boxes[which(boxes$Box == "SBocean"), ]

# Scots Bay
SUA = read.csv("polygon_SBEastern.csv")
polyEastern = as.PolySet(SUA, projection="LL")

SUA = read.csv("polygon_SBNorthern.csv")
polyNorthern = as.PolySet(SUA, projection="LL")

SUA = read.csv("polygon_SB.csv")
polySB_main = as.PolySet(SUA, projection="LL")

#German Bank CTD box
GBCTD=boxes[which(boxes$Box == "GBocean"), ]

# German Bank      
SUA = read.csv("polygon_GB.csv")
polyGB = as.PolySet(SUA, projection="LL")

# Seal Island      
SUA = read.csv("polygon_SI.csv")
polySI = as.PolySet(SUA, projection="LL")
```

### `r surv2` Survey \#`r surv.no` - `r StartDate` {.tabset}

This survey will include `r vessels` participating vessels. 

```{r echo=FALSE}
a=if(surv == "SB" & !is.na(EVessel) & !is.na(NVessel)){
  paste(EVessel, "and", NVessel, "will run 4 lines in the East and North boxes, and all other vessels will be running 2 lines in the Main Survey Box")
}

b=if(surv == "SB" & is.na(EVessel) & !is.na(NVessel)){
  paste(NVessel, "will run 4 lines in the North box, and all other vessels will be running 2 lines in the Main Survey Box")
}

c=if(surv == "SB" & is.na(EVessel) & is.na(NVessel)){
  "All vessels will be running 2 lines in the Main Survey Box"
}

d=if(surv=="GB"){
  "All vessels are to complete two lnes each in the German Survey Box and one line in the Seal Island Box"
}

e=if(surv == "SB" & !is.na(EVessel) & is.na(NVessel)){
  paste(EVessel, "will run 4 lines in the East box, and all other vessels will be running 2 lines in the Main Survey Box")
}

f=if(!is.na(Tagging)){
  paste0("Tagging will be conducted from the ", Tagging, ".")
}

#The `r PlanktonVessel` will conduct plankton tows and oceanographic sampling. 
```

Vessels will complete the following lines: `r a` `r b` `r c` `r d` `r e`.

The survey will have a start time of `r StartTime`. 

`r f`

```{r}
c=if(surv=="SB"){
  "Vessels are reminded to complete their assigned transects as listed, straight, and without deviating."
}

#Afterwards, school surveying can be conducted while waiting to begin fishing but not before the assigned transects have been completed. Please run at least 3 parallel lines over the school and ensure the fishing sonars are turned off. 
```

`r c`

 **When running your transect, if you are recording a school of fish but are near the end of your line, please continue recording in a straight line even if it extends beyond the boundaries of the survey box.**

```{r, fig.width=7, fig.height=4}
Plan2 = Plan %>%
  dplyr::select(X = "Start Lon", Y = "Start Lat", Xend = "End Lon", Yend = "End Lat", Vessel)

if(surv=="GB"){a = ggplot(Plan2, aes(x=X, y=Y)) + 
  geom_polygon(data=GBout,aes(x=long, y=lat, group=group), fill = "gray") + 
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID),fill='white',col='black') +
  geom_segment(data=Plan2, aes(x = X, y = Y, xend = Xend, yend = Yend, colour = Vessel), size=0.5) + 
  coord_map() + 
  labs(x=NULL, y=NULL, caption = "Figure 1. Survey lines to be completed by participating vessels.")}

if(surv=="SB"){a = ggplot(Plan2, aes(x=X, y=Y)) + 
    geom_polygon(data=SBout,aes(x=long, y=lat, group=group), fill = "gray") + 
    geom_polygon(data=SBplankton,aes(x=X, y=Y, group=PID),fill='white',col='black') +
    geom_polygon(data=SBCTD,aes(x=X, y=Y, group=PID),fill='white',col='black') +
    geom_segment(data=Plan2, aes(x = X, y = Y, xend = Xend, yend = Yend, colour = Vessel), size=0.5) +
    coord_map() + 
    labs(x=NULL, y=NULL, caption = "Figure 1. Survey lines to be completed by participating vessels.")}

print(a)
```

```{r}
a=if(surv=="SB"){
  paste0(PlanktonVessel, " will complete both plankton towing (bottom left outer box) and CTD casts (inner box)")
}
b=if(surv=="GB"){
  paste0(PlanktonVessel, "will complete both plankton towing and CTD casts (northern small box)")
}
```

The `r a` `r b`.

```{r}
if(surv=="SB"){
  kables(list(
  kable(CTDBox, caption = "CTD Box") %>%
  kable_styling(full_width = FALSE, position = "float_left"),
  kable(TowBox, caption = "Tow Box") %>%
  kable_styling(full_width = FALSE, position = "right")))
}

if(surv=="GB"){
  kbl(CTDBox, caption = "CTD Box") %>%
  kable_styling(full_width = FALSE)
}
```

##### Full Lines Table

```{r}
Plan$`Start Lat` = conv_unit(Plan$`Start Lat`, "dec_deg", "deg_dec_min")
Plan$`Start Lon` = conv_unit(Plan$`Start Lon`, "dec_deg", "deg_dec_min")
Plan$`End Lat` = conv_unit(Plan$`End Lat`, "dec_deg", "deg_dec_min")
Plan$`End Lon` = conv_unit(Plan$`End Lon`, "dec_deg", "deg_dec_min")

Plan = Plan %>%
  mutate('Start Lat' = substr(Plan$`Start Lat`, 1, 8)) %>%
  mutate('End Lat' = substr(Plan$`End Lat`, 1, 8)) %>%
  mutate('Start Lon' = substr(Plan$`Start Lon`, 2, 10)) %>%
  mutate('End Lon' = substr(Plan$`End Lon`, 2, 10))

degree = str_split_i(Plan$`Start Lat`, " ", -2)
end = str_split_i(Plan$`Start Lat`, " ", 2)
decimal = as.numeric(str_split_i(end, "\\.", 1))
decimal = sprintf("%02d", decimal)
minutes = as.numeric(str_split_i(end, "\\.", -1))
minutes = sprintf("%02d", minutes)
minutes = str_pad(minutes, width=3, side="right", pad="0")
all = paste0(degree,decimal,".",minutes)
Plan$`Start Lat` = all

degree = str_split_i(Plan$`End Lat`, " ", -2)
end = str_split_i(Plan$`End Lat`, " ", 2)
decimal = as.numeric(str_split_i(end, "\\.", 1))
decimal = sprintf("%02d", decimal)
minutes = as.numeric(str_split_i(end, "\\.", -1))
minutes = sprintf("%02d", minutes)
minutes = str_pad(minutes, width=3, side="right", pad="0")
all = paste0(degree,decimal,".",minutes)
Plan$`End Lat` = all

degree = str_split_i(Plan$`Start Lon`, " ", -2)
end = str_split_i(Plan$`Start Lon`, " ", 2)
decimal = as.numeric(str_split_i(end, "\\.", 1))
decimal = sprintf("%02d", decimal)
minutes = as.numeric(str_split_i(end, "\\.", -1))
minutes = sprintf("%02d", minutes)
minutes = str_pad(minutes, width=3, side="right", pad="0")
all = paste0(degree,decimal,".",minutes)
Plan$`Start Lon` = all

degree = str_split_i(Plan$`End Lon`, " ", -2)
end = str_split_i(Plan$`End Lon`, " ", 2)
decimal = as.numeric(str_split_i(end, "\\.", 1))
decimal = sprintf("%02d", decimal)
minutes = as.numeric(str_split_i(end, "\\.", -1))
minutes = sprintf("%02d", minutes)
minutes = str_pad(minutes, width=3, side="right", pad="0")
all = paste0(degree,decimal,".",minutes)
Plan$`End Lon` = all

Plan %>%
  arrange(Vessel) %>%
  kbl() %>%
  kable_styling(full_width=FALSE) 
```

### Instructions

1. Plan to arrive at the starting point 30 minutes before the start time of `r StartTime`.

2. Start the EK80 software and load the ‘Herring Survey 2023’ settings. When you are ready to
begin, Record Raw should be turned ‘ON’ and the ‘REC’ dot in the upper left should turn
from black to red. Finally, check that the lat and long in the top center of the screen is
changing.

3. Commence surveying first line at `r StartTime` and maintain a speed at 8 knots.

4. Run your lines straight and double check that the recorder is turned on and red.

5. Maintain deck sheets as a backup to recorders every 15 minutes.

6. Note the time when finished your last line.

```{r, include="FALSE"}

b=surv.date+days(1)
c=substr(b,1,10)
d=paste0(Allocation, "mt/vessel.")
e=paste0(Allocation, "mt/vessel for German Bank and ", SIAllocation, "mt/vessel for Seal Island.")
i= "7. This is a non-fishing survey."
h=if(Allocation == 0){
  print(i)
}
f=if(surv=="SB" & Allocation != 0){
  paste0("7. Fishing to start on ", c, ", and allocation is ", d)
}
g=if(surv=="GB" & Allocation != 0){
  paste0("7. Fishing to start on ", c, ", and allocation is ", e,)
}
```

`r g` `r f` `r h`

```{r, results="asis"}
if(surv=="SB"){
  cat("\n")
  cat("### Tidal Charts", "\n")
  cat("\n")
  knitr::include_graphics(path=paste0("C:/Users/", Sys.info()[7],"/Documents/GitHub/HerringScience.github.io/Surveys/", year, "/", surv, surv.no, "/Hourly.jpg"), rel_path = FALSE)
}
```

```{r}
if(surv=="SB"){
    knitr::include_graphics(paste0("C:/Users/", Sys.info()[7],"/Documents/GitHub/HerringScience.github.io/Surveys/", year, "/", surv, surv.no, "/Daily.jpg"), rel_path = FALSE)
}
```