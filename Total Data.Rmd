---
title: "HSC Data Compendium"
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    highlight: kate
---

```{r setup, include=FALSE}
year= substr(Sys.Date(),1,4)
knitr::opts_knit$set(root.dir = paste0("C:/Users/", Sys.info()[7],"/Documents/GitHub/HerringScience.github.io/"))
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, fig.align='center')
```

```{r Data Import, include=FALSE}
#Import all packages, CTD data, and land data

#Packages
setwd(paste0("C:/Users/", Sys.info()[7],"/Documents/GitHub/HerringScience.github.io/Main Data/"))
library(ggplot2)
library(patchwork)
library(scales)
library(cli)
library(lubridate)
library(reprex)
library(tidyverse)
library(geosphere)
library(reshape2)
library(moderndive)
library(skimr)
library(ggridges)
#library(weathercan)
library(GGally)
library(psych)
library(raster)
library(PBSmapping)
#library(rgeos)
library(sf)
library(terra)
library(knitr)
library(kableExtra)
library(grid)
library(gridExtra)
library(cowplot)
library(DT)
library(dygraphs)
library(leaflet)
library(rmapshaper)
library(plotly)
library(mapproj)
library(oce) #new CTD Data package

#Tagging Data
Tag = read_csv("TaggingEvents.csv") #Tagging Data
polysT = read_csv("timGrounds.csv") #Coloured ground maps
Tag$Year = as.factor(Tag$Year)
Tag$Vessel = as.factor(Tag$Vessel)
Tag$Survey = as.factor(Tag$Survey)
Tag$Tagger = as.factor(Tag$Tagger)

#CTD Data
SST = read_csv("CTD SST.csv") #SST
polysT = read_csv("timGrounds.csv") #coloured ground maps
CTD = read_csv("CTD Full.csv") #All Data
atDepth = read_csv("CTD 30m.csv") #At 30m Depth > This one contains all Stratified Temp + Salinity data as well
SST$Year <- as.factor(SST$Year)
SST$Month <- as.factor(SST$Month)
atDepth$Year <- as.factor(atDepth$Year)
atDepth$Month <- as.factor(atDepth$Month)
CTD$Year <- as.factor(CTD$Year)
CTD$Month <- as.factor(CTD$Month)
CTD$Survey <- as.factor(CTD$Survey)
CTD <- CTD %>%
  mutate(Julian_factor = Julian)
CTD$Julian_factor <- as.factor(CTD$Julian_factor)

#SSB Data
SSB = read_csv("SSB Estimates.csv")
SSB$Year <- as.factor(SSB$Year)
SSB$Survey_Number <- as.factor(SSB$Survey_Number)
SSB$Ground <- as.factor(SSB$Ground)

#LRP Data
LRP2 = read_csv("LRP Data.csv")
LRP2 = LRP2 %>% rename(ThreeYear = "3yr Avg")

#Fat Data
FatData = read_csv("Total Fat Data.csv")

#Larval Data
#All Adjusted Ages and Dates are originally added in Larval QC script.
#All preservative length adjustments added in in Larval QC script.
# if preservative is formalin, apply L  = 0.984 + 0.993 x X1. (X1 = fixed/preserved length therefore Larval$Lengthmm, L = Live length.) 
# if preservation is alcohol apply L = 0.532 + 0.989 x X1 
#This is taken from Fox 1996 alcohol vs Formalin paper. They did 5% and 5 minute net capture simulation. They did suggest that this adjustment would be less accurate the longer the tow period.
# These equations are when the maximum shrinkage has occurred.
Larval = read_csv("Full Larval.csv")

Larval$Date <- lubridate::ymd(Larval$Date)
  Larval <- dplyr::arrange(Larval, Date)
Larval$Year <- as.factor(Larval$Year)
Larval$category <- as.factor(Larval$category)
Larval$Survey.No <- as.factor(Larval$Survey.No)
Larval$MonthDay <- format(Larval$Date, "%m-%d")
LarvalSI = filter(Larval, Ground == "SI")


LarvalSum = read_csv("LarvalSum.csv")
LarvalSum$Year <- as.factor(LarvalSum$Year)

#Land Data
can<-getData('GADM', country="CAN", level=1)
us = getData('GADM', country = "USA", level = 1)
can1 = rbind(can,us)
NBNS <- can1[can1@data$NAME_1%in%c("New Brunswick","Nova Scotia","Prince Edward Island","Newfoundland and Labrador","QuÃ©bec", "Maine"),]
```

```{r Box Import}
#Import All Boxes
setwd(paste0("C:/Users/", Sys.info()[7],"/Documents/GitHub/HerringScience.github.io/Box Coordinates/"))
boxes = read.csv("surveyBoxes.csv")

# Scots Bay plankton and CTD box
SBplankton=boxes[which(boxes$Box == "SBPlanktonBox"), ]
SBCTD=boxes[which(boxes$Box == "SBocean"), ]

# Scots Bay
SUA = read.csv("polygon_SBEastern.csv")
polyEastern = as.PolySet(SUA, projection="LL")

SUA = read.csv("polygon_SBNorthern.csv")
polyNorthern = as.PolySet(SUA, projection="LL")

SUA = read.csv("polygon_SB.csv")
polySB_main = as.PolySet(SUA, projection="LL")

#German Bank CTD box
GBCTD=boxes[which(boxes$Box == "GBocean"), ]

# German Bank      
SUA = read.csv("polygon_GB.csv")
polyGB = as.PolySet(SUA, projection="LL")

# Seal Island      
SUA = read.csv("polygon_SI.csv")
polySI = as.PolySet(SUA, projection="LL")
```

# {.tabset}

## SSB Estimates

### LRP Data {.tabset}

#### Total

```{r echo=FALSE}
LRP2 %>% dplyr::select(Year, Biomass, LRP, ThreeYear) %>%
  dygraph(ylab = "Biomass (mt)", xlab = "Year") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.8,
              hideOnMouseOut = FALSE)
```

```{r echo=FALSE}
LRP3 = LRP2 %>%
  dplyr::select(Year, Scots, German, Seal, Biomass, LRP, ThreeYear="ThreeYear") %>%
  mutate(Difference = ThreeYear-LRP)

LRP3 %>% arrange(desc(Year)) %>%
  datatable(colnames = c("Year", "Scots Bay", "German Bank", "Seal Isl.", "Biomass (mt)", "LRP", "3yr Avg", "Difference"),
  extensions = 'Buttons',
  options = list(
  pageLength = 5,
  dom = 'lfrtiBp', 
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
  formatStyle(columns = "Difference", color = styleInterval(cuts = 0, values = c("red", "green")))
```

#### Scots Bay

```{r}
LRP3 %>% dplyr::select(Year, Scots) %>% 
  dygraph(ylab = "Biomass (mt)", xlab = "Year") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.8,
              hideOnMouseOut = FALSE)
```

```{r echo=FALSE}
LRP3 %>%
  dplyr::select(Year, Scots) %>%
  arrange(desc(Year)) %>%
  datatable(colnames = c("Year", "Scots Bay"),
          extensions = 'Buttons',
          options = list(
            pagelength = 5,
            dom = 'lfrtiBp',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```

#### German Bank

```{r}
LRP3 %>% dplyr::select(Year, German) %>% 
  dygraph(ylab = "Biomass (mt)", xlab = "Year") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.8,
              hideOnMouseOut = FALSE)
```

```{r echo=FALSE}
LRP3 %>%
  dplyr::select(Year, German, Seal) %>%
  arrange(desc(Year)) %>%
  datatable(colnames = c("Year", "German Bank", "Seal Isl."),
          extensions = 'Buttons',
          options = list(
            pagelength = 5,
            dom = 'lfrtiBp',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```

#### Seal Island

```{r}

LRP3 %>% filter(Year > 2017) %>%
  dplyr::select(Year, Seal) %>%
  dygraph(ylab = "Biomass (mt)", xlab = "Year") %>%
  #breaks=unique(as.integer("x")) %>% #use as as.integer for x axis to reformat to full years?
  dyOptions(drawPoints = TRUE, pointSize = 2, digitsAfterDecimal = 0) %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.8,
              hideOnMouseOut = FALSE)
```

```{r echo=FALSE}
LRP3 %>% filter(Year > 2017) %>%
  dplyr::select(Year, Seal) %>%
  arrange(desc(Year)) %>%
  datatable(colnames = c("Year", "Seal Isl."),
          extensions = 'Buttons',
          options = list(
            pagelength = 5,
            dom = 'lfrtiBp',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```


### Total SSB Summaries {.tabset}

#### Total

```{r echo=FALSE}
Plot_Summary = SSB %>%
  filter(Ground == "Scots Bay" | Ground == "German Bank" | Ground == "Seal Island") %>%
  filter(!is.na(DFO_Turnover_Adjusted)) %>%
  group_by(Year) %>%
  summarize(Biomass = sum(DFO_Turnover_Adjusted), na.rm = FALSE)

p = ggplot(data=Plot_Summary,  aes(x=Year, y=Biomass)) +
  geom_col(fill = "darkblue") +
  scale_y_continuous(labels=scales::comma) +
  labs(x="Year", y = "DFO Estimate w/ Turnover") +
  theme(axis.text.x = element_text(angle = 55), legend.position = "none")

ggplotly(p)
```

```{r echo=FALSE}
Table = SSB %>%
  filter(Ground == "Scots Bay" | Ground == "German Bank" | Ground == "Seal Island") %>%
  filter(!is.na(DFO_Turnover_Adjusted)) %>%
  group_by(Year) %>%
  summarize(HSC_Estimate = sum(HSC_Estimate),
            HSC_Turnover_Adjusted = sum(HSC_Turnover_Adjusted),
            DFO_Estmate = sum(DFO_Estimate),
            DFO_Turnover_Adjusted = sum(DFO_Turnover_Adjusted)) %>%
  arrange(desc(Year))

datatable(Table, 
          colnames = c("Year", "HSC Estimate", "HSC w/ Turnover", "DFO Estimate", "DFO w/ Turnover"), 
          extensions = 'Buttons',
  options = list(
  pageLength = 5,
  dom = 'lfrtiBp', 
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```

#### Scots Bay

```{r echo=FALSE}
p = ggplot(data=subset(SSB, Ground == "Scots Bay"),  aes(x=Year, y=DFO_Turnover_Adjusted, fill= Survey_Number)) +
  geom_col() +
  scale_y_continuous(labels=scales::comma) +
  labs(x="Year", y = "DFO Estimate w/ Turnover") +
  theme(axis.text.x = element_text(angle = 55), legend.position = "none")

ggplotly(p)
```

```{r echo=FALSE}
Table = SSB %>%
  filter(Ground == "Scots Bay") %>%
  group_by(Year) %>%
  summarize(HSC_Estimate = sum(HSC_Estimate),
            HSC_Turnover_Adjusted = sum(HSC_Turnover_Adjusted),
            DFO_Estmate = sum(DFO_Estimate),
            DFO_Turnover_Adjusted = sum(DFO_Turnover_Adjusted)) %>%
  ungroup() %>%
  arrange(desc(Year))

datatable(Table, colnames = c("Year", "HSC Estimate", "HSC w/ Turnover", "DFO Estimate", "DFO w/ Turnover"),
          extensions = 'Buttons',
  options = list(
  pageLength = 5,
  dom = 'lfrtiBp', 
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))

```


#### German Bank

```{r echo=FALSE}
p = ggplot(data=subset(SSB, Ground == "German Bank"),  aes(x=Year, y=DFO_Turnover_Adjusted, fill= Survey_Number)) +
  geom_col() +
  scale_y_continuous(labels=scales::comma) +
  labs(x="Year", y = "DFO Estimate w/ Turnover") +
  theme(axis.text.x = element_text(angle = 55), legend.position = "none")

ggplotly(p)
```

```{r echo=FALSE}
Table = SSB %>%
  filter(Ground == "German Bank") %>%
  group_by(Year) %>%
  summarize(HSC_Estimate = sum(HSC_Estimate),
            HSC_Turnover_Adjusted = sum(HSC_Turnover_Adjusted),
            DFO_Estmate = sum(DFO_Estimate),
            DFO_Turnover_Adjusted = sum(DFO_Turnover_Adjusted)) %>%
  ungroup() %>%
  arrange(desc(Year))

datatable(Table, colnames = c("Year", "HSC Estimate", "HSC w/ Turnover", "DFO Estimate", "DFO w/ Turnover"),
          extensions = 'Buttons',
  options = list(
  pageLength = 5,
  dom = 'lfrtiBp', 
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```

#### Seal Island

```{r echo=FALSE}
p = ggplot(data=subset(SSB, Ground == "Seal Island"),  aes(x=Year, y=DFO_Turnover_Adjusted, fill= Survey_Number)) +
  geom_col() +
  scale_y_continuous(labels=scales::comma) +
  labs(x="Year", y = "DFO Estimate w/ Turnover") +
  theme(axis.text.x = element_text(angle = 55), legend.position = "none")

ggplotly(p)
```

```{r echo=FALSE}
Table = SSB %>%
  filter(Ground == "Seal Island") %>%
  group_by(Year) %>%
  summarize(HSC_Estimate = sum(HSC_Estimate),
            HSC_Turnover_Adjusted = sum(HSC_Turnover_Adjusted),
            DFO_Estmate = sum(DFO_Estimate),
            DFO_Turnover_Adjusted = sum(DFO_Turnover_Adjusted)) %>%
  ungroup() %>%
  arrange(desc(Year))

datatable(Table, colnames = c("Year", "HSC Estimate", "HSC w/ Turnover", "DFO Estimate", "DFO w/ Turnover"),
          extensions = 'Buttons',
  options = list(
  pageLength = 5,
  dom = 'lfrtiBp', 
  buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))

```


### Annual SSB Estimates {.tabset}

#### Scots Bay {.tabset .tabset-pills}

```{r, results = "asis", fig.align='center'}
DFOSSB = SSB %>% dplyr::select(Year, Ground, Survey_Number, DFO_Turnover_Adjusted)
for(i in unique(SSB$Year)) {
  cat("\n")
  cat("##### ", i, "\n")
  cat("\n")
  
  
print(ggplot(data=subset(SSB, Ground == "Scots Bay" & Year == i), aes(x=Survey_Number, y=DFO_Turnover_Adjusted, group=1)) +
  geom_point(stat='summary', fun.y=sum) +
  stat_summary(fun.y=sum, geo="line") +
  labs(x="Survey Number", y="DFO Biomass w/ Turnover"))
  cat("\n")
  print(kbl(x=subset(DFOSSB, Ground == "Scots Bay" & Year == i), align = "c", col.names = c("Year", "Ground", "Survey Number", "DFO (Turnover Adjusted)")) %>%
          kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### German Bank {.tabset .tabset-pills}

```{r, results = "asis", fig.align='center'}
DFOSSB = SSB %>% dplyr::select(Year, Ground, Survey_Number, DFO_Turnover_Adjusted)
for(i in unique(SSB$Year)) {
  cat("\n")
  cat("##### ", i, "\n")
  cat("\n")
  
print(ggplot(data=subset(SSB, Ground == "German Bank" & Year == i), aes(x=Survey_Number, y=DFO_Turnover_Adjusted, group=1)) +
  geom_point(stat='summary', fun.y=sum) +
  stat_summary(fun.y=sum, geo="line") +
  labs(x="Survey Number", y="DFO Biomass w/ Turnover"))
  cat("\n")
  print(kbl(x=subset(DFOSSB, Ground == "German Bank" & Year == i), align = "c", col.names = c("Year", "Ground", "Survey Number", "DFO (Turnover Adjusted)")) %>%
          kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Seal Island {.tabset .tabset-pills}

```{r, results = "asis", fig.align='center'}
DFOSSB = SSB %>%
  dplyr::select(Year, Ground, Survey_Number, DFO_Turnover_Adjusted)

SSB1 <- subset(SSB, Year == 2018 | Year == 2019 | Year == 2020 | Year == 2021 )
  
for(i in unique(SSB1$Year)) {
  cat("\n")
  cat("##### ", i, "\n")
  cat("\n")
  
  print(ggplot(data=subset(SSB, Ground == "Seal Island" & Year == i), aes(x=Survey_Number, y=DFO_Turnover_Adjusted, group=1)) +
  geom_point(stat='summary', fun.y=sum) +
  stat_summary(fun.y=sum, geo="line") +
  labs(x="Survey Number", y="DFO Biomass w/ Turnover"))
  cat("\n")
  print(kbl(x=subset(DFOSSB, Ground == "Seal Island" & Year == i), align = "c", col.names = c("Year", "Ground", "Survey Number", "DFO (Turnover Adjusted)")) %>%
          kable_paper("striped", full_width = F))
  cat("\n")
}
```

## Tagging Project

### Current Tag Data {.tabset}

#### Scots Bay {.tabset .tabset-pills}

```{r}
CP <- as(extent(-65.5, -64.5, 45, 45.5), "SpatialPolygons") #set boundaries for Scots Bay before plotting
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)
```

##### Total

```{r echo=FALSE}

#Plot = Tag %>% subset(Ground == "Scots Bay" & Year == year) %>% group_by(Survey) %>% mutate(group2=paste0(Survey,", n=",length(Survey))) %>% ungroup() #Line for when using system year.
Plot = Tag %>% subset(Ground == "Scots Bay" & Year == 2023) %>% group_by(Survey) %>% mutate(group2=paste0(Survey,", n=",length(Survey))) %>% ungroup() #Line for previous year when it does not match system year. Used for before the season starts.

ggplot(data = Plot, aes(x=Lon, y=Lat)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polySB_main,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBplankton,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyNorthern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polyEastern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_point(aes(fill = group2), pch=21, size = 2) +
  coord_map() + 
  labs(x=NULL, y=NULL, fill="Survey, # of Tags")
```

```{r, results = "asis"}
Tag1 = Tag %>% 
  filter(Year == year & Ground == "Scots Bay") %>%
  arrange(Survey) %>%
  group_by(Vessel, Survey) %>%
  mutate(group2=paste0(Vessel, ", n=", length(Vessel))) %>%
  ungroup()

for(i in unique(Tag1$Survey)) {
  cat("\n")
  cat("##### Survey", i, "\n")
  cat("\n")
  
  print(ggplot(data = subset(Tag1, Survey == i), aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polySB_main,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=SBplankton,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyNorthern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polyEastern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_point(aes(fill = group2), pch=21, size = 2) +
  coord_map() + 
  labs(x=NULL, y=NULL, fill = "Vessel, # of Tags"))
  cat("\n")
}
```

#### German Bank {.tabset .tabset-pills}

```{r message=FALSE, warning=FALSE}
CP <- as(extent(-66.5, -65.5, 43, 44), "SpatialPolygons") #set boundaries for German Bank before plotting
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)
```

##### Total

```{r echo=FALSE, fig.align='center'}
#Plot = Tag %>% subset(Ground == "German Bank" & Year == year) %>% group_by(Survey) %>% mutate(group2=paste0(Survey,", n=",length(Survey))) %>% ungroup() #To use when you are currently in a survey period
Plot = Tag %>% subset(Ground == "German Bank" & Year == 2023) %>% group_by(Survey) %>% mutate(group2=paste0(Survey,", n=",length(Survey))) %>% ungroup() #Set previous survey year when you are between survey periods.

ggplot(data = Plot, aes(x=Lon, y=Lat)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_point(aes(fill = group2), pch=21, size = 2) +
  coord_map() + 
  labs(x=NULL, y=NULL, fill="Survey, # of Tags")
```

```{r, results = "asis"}
Tag1 = Tag %>% 
  filter(Year == year & Ground == "German Bank") %>%
  arrange(Survey) %>%
  group_by(Vessel, Survey) %>%
  mutate(group2=paste0(Vessel, ", n=", length(Vessel))) %>%
  ungroup()

for(i in unique(Tag1$Survey)) {
  cat("\n")
  cat("##### Survey", i, "\n")
  cat("\n")
  
  print(ggplot(data = subset(Tag1, Survey == i), aes(x=Lon, y=Lat)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_point(aes(fill = group2), pch=21, size = 2) +
  coord_map() + 
  labs(x=NULL, y=NULL, fill="Vessel, # of Tags"))
  cat("\n")
}
```

### Tag Summaries {.tabset}

#### Annual Summary

::: row
::: col-md-6
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Reset spatial extent back to full view
CP <- as(extent(-69, -63, 42, 45.5), "SpatialPolygons")
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)

ggplot(data = subset(Tag, Lon < -64.1), aes(x=Lon, y=Lat)) + 
 geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") + 
 geom_polygon(data=out,aes(x=long, y=lat, group=group),fill='burlywood4',col='black') +
 geom_point(pch=21, size = 2, fill = "White") + 
 ggtitle("Tagging Locations") + 
 labs(x=NULL, y=NULL) + 
 coord_map() + 
 theme(panel.background = element_rect(fill = "grey68"))
```
:::

::: col-md-6
```{r}
Annual_Table = Tag %>%
  group_by(Year) %>%
  summarise(n=n()) %>%
  rename(Tags = n)

kbl(Annual_Table) %>%
  kable_paper("striped", full_width = F)
```
:::
:::

#### Tagger Summary

::: row
::: col-md-6
```{r echo=FALSE}
#Reset spatial extent back to full view
CP <- as(extent(-69, -61.5, 42, 45.5), "SpatialPolygons")
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)

ggplot(data = Tag, aes(x=Lon, y=Lat)) + 
 geom_polygon(data=out,aes(x=long, y=lat, group=group),fill='burlywood4',col='black') +
 geom_point(data = Tag, aes(fill = Tagger), pch=21, size = 2)+ 
  ggtitle("Tagging Locations") + 
 labs(x=NULL, y=NULL) + 
 coord_map() + 
 theme(panel.background = element_rect(fill = "grey68"))
```
:::

::: col-md-6
```{r}
Tagger_Table = Tag %>%
  group_by(Tagger) %>%
  summarise(Tag_Annual = mean(Tag_Annual)) %>%
  mutate_if(is.numeric, format, digits=1)

kbl(Tagger_Table, col.names = c("Tagger", "Average Tags/Year")) %>%
  kable_paper("striped", full_width = F)
```
:::
:::

### Tag Returns

Could show a table of annual return rates, a map of linked returns by year, etc.

Whatever summarized data the tagger tech has.

## CTD Project

### Current CTD Data {.tabset}

#### Scots Bay {.tabset .tabset-pills}

##### Total

```{r message=FALSE, warning=FALSE}
CP <- as(extent(-65.5, -64.5, 45, 45.5), "SpatialPolygons") #set boundaries for Scots Bay before plotting
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)
```

```{r echo=FALSE}

#ggplot(data = subset(CTD, Ground == "Scots Bay" & Year == year & In_Box == "1"), aes(x=Lon, y=Lat)) + #To use if within the survey season

ggplot(data = subset(CTD, Ground == "Scots Bay" & Year == 2023 & In_Box == "1"), aes(x=Lon, y=Lat)) + #To use if outside of the survey season. Reset year.
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polySB_main,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBplankton,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyNorthern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polyEastern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_point(aes(fill = Survey), pch=21, size = 2) +
  coord_map() + 
  labs(x=NULL, y=NULL)

#ggplot(data = subset(CTD, Ground == "Scots Bay" & Year == year), aes(x=Temperature, y=Depth, colour = Julian_factor)) + #To use if within the survey season
ggplot(data = subset(CTD, Ground == "Scots Bay" & Year == 2023), aes(x=Temperature, y=Depth, colour = Julian_factor)) + #To use if outside of the survey season. Reset year.
geom_path(size = 1.5) + 
scale_y_reverse() + 
labs(x="Temperature (Â°C)", y = "Depth (m)", colour='Julian Day', title = "Temperature (Â°C) vs. Depth (m)")
```

```{r, results = "asis"}
#CTD1 = CTD %>% 
  # filter(Year == year & Ground == "Scots Bay") %>%
  # arrange(Survey)                                          # To use within the survey window

CTD1 = CTD %>% 
   filter(Year == 2023 & Ground == "Scots Bay") %>%
   arrange(Survey)                                           # To use outside of Survey window. Reset year.

for(i in unique(CTD1$Survey)) {
  
  cat("\n")
  cat("##### Survey", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(CTD1, Survey == i), aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polySB_main,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=SBplankton,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyNorthern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polyEastern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_point(pch=21, size = 2, fill = "red") +
  coord_map() + 
  labs(x=NULL, y=NULL))
  cat("\n")
  
print(ggplot(data = subset(CTD1, Survey == i), aes(x=Temperature, y=Depth)) + 
geom_path(size = 1.5) + 
scale_y_reverse() + 
labs(x="Temperature (Â°C)", y = "Depth (m)", title = "Temperature (Â°C) vs. Depth (m)"))
  cat("\n")
}
```

#### German Bank {.tabset .tabset-pills}

##### Total

```{r message=FALSE, warning=FALSE}
CP <- as(extent(-66.5, -65.5, 43, 44), "SpatialPolygons") #set boundaries for German Bank before plotting
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)
```

```{r echo=FALSE}
# ggplot(data = subset(CTD, Ground == "German Bank" & Year == year & In_Box == "1"), aes(x=Lon, y=Lat)) + #To use within the survey window
ggplot(data = subset(CTD, Ground == "German Bank" & Year == 2023 & In_Box == "1"), aes(x=Lon, y=Lat)) +  #To use outside of the survey window. Reset Year. 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_point(aes(fill = Survey), pch=21, size = 2) +
  coord_map() + 
  labs(x=NULL, y=NULL)

#ggplot(data = subset(CTD, Ground == "German Bank" & Year == year), aes(x=Temperature, y=Depth, colour = Julian_factor)) +  #To use within the survey window
ggplot(data = subset(CTD, Ground == "German Bank" & Year == 2023), aes(x=Temperature, y=Depth, colour = Julian_factor)) +   # To use outside of the survey window. Reset Year.
geom_path(size = 1.5) + 
scale_y_reverse() + 
labs(x="Temperature (Â°C)", y = "Depth (m)", colour='Julian Day', title = "Temperature (Â°C) vs. Depth (m)")
```

```{r, results = "asis"}
CTD1 = CTD %>% 
  filter(Year == year & Ground == "German Bank") %>%
  arrange(Survey)

for(i in unique(CTD1$Survey)) {
  
  cat("\n")
  cat("##### Survey", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(CTD1, Survey == i), aes(x=Lon, y=Lat)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_point(pch=21, size = 2, fill = "red") +
  coord_map() + 
  labs(x=NULL, y=NULL))
  cat("\n")
  
print(ggplot(data = subset(CTD1, Survey == i), aes(x=Temperature, y=Depth)) + 
geom_path(size = 1.5) + 
scale_y_reverse() + 
labs(x="Temperature (Â°C)", y = "Depth (m)", title = "Temperature (Â°C) vs. Depth (m)"))
  cat("\n")
}
```

### Annual CTD Data {.tabset}

#### Scots Bay {.tabset}

##### Sea Surface Temperatures (SST) {.tabset .tabset-pills}

###### Total

```{r out.width="30%", fig.show="hold"}
ggplot(data = subset(SST, Ground == "Scots Bay" & In_Box == "1"), aes(x = Julian, y = Temperature, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Sea Surface Temperature") +
  xlab("Julian Day") +
  ggtitle("Scots Bay")

Summer = SST %>% 
  subset(Ground == "Scots Bay" & In_Box == "1" & Month == "8")

ggplot(data = Summer, aes(x=Year, y=Temperature, group = Year, colour = Year))+
  geom_boxplot() +
  ylab("Average Sea Surface Temperature") +
  ggtitle("August SST") +
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(8.5,16.5)

ggplot(data = subset(SST, Ground == "Scots Bay" & In_Box == "1"), aes(x=Year, y=Temperature, group = Year, colour = Year)) +
  geom_boxplot() + 
  facet_wrap(~Month) + 
  ylim(7.5, 15.5) + 
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  labs(x="Year", y = "Sea Surface Temperature (SST) (C)", title = "Scots Bay: Monthly SST vs. Year") +
  theme(axis.text.x = element_text(angle = 55))
```

```{r, results = "asis"}
SST1 = SST %>% 
  filter(Ground == "Scots Bay" & In_Box == "1") %>%
  arrange(Survey) %>%
  arrange(Year)

for(i in unique(SST1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(SST1, Year == i), aes(x = Julian, y = Temperature)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Sea Surface Temperature") +
  xlab("Julian Day") +
  ylim(NA, 16) +
  ggtitle("Scots Bay"))
  cat("\n")
}
```

##### At Depth Temperatures (30m) {.tabset .tabset-pills}

###### Total

```{r out.width="30%", fig.show="hold"}
ggplot(data = subset(atDepth, Ground == "Scots Bay" & In_Box == "1"), aes(x = Julian, y = Temperature, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Temperature at 30m Depth") + 
  xlab("Julian Day") + 
  ggtitle("Scots Bay")

Summer = atDepth %>% 
  subset(Ground == "Scots Bay" & In_Box == "1" & Month == "8")

ggplot(data = Summer, aes(x=Year, y=Temperature, group = Year, colour = Year))+
  geom_boxplot() +
  ylab("Average Temperature at 30m Depth") +
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(9,15) +
  ggtitle("August At-Depth Temperature")

ggplot(data = subset(atDepth, Ground == "Scots Bay" & In_Box == "1"), aes(x=Year, y=Temperature, group = Year, colour = Year)) + 
  geom_boxplot() + 
  facet_wrap(~Month) + 
  ylim(7.5, 14.5) + 
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  labs(x="Year", y = "Temperature (C) at 30m Depth", title = "Scots Bay: Monthly 30m Temperature vs. Year") +
  theme(axis.text.x = element_text(angle = 55))
```


```{r, results = "asis"}
atDepth1 = atDepth %>% 
  filter(Ground == "Scots Bay" & In_Box == "1") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = Temperature)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Temperature at 30m Depth") +
  xlab("Julian Day") +
  ylim(NA, 16) +
  ggtitle("Scots Bay"))
  cat("\n")
}
```

##### Stratified Temperatures {.tabset .tabset-pills}

###### Total

```{r}
ggplot(data = subset(atDepth, Ground == "Scots Bay" & In_Box == "1"), aes(x = Julian, y = StratTemp, colour = Year)) + 
  geom_point() + 
  ylab("Temperature Difference") + 
  xlab("Julian Day") + 
  ylim(NA, 1.7) +
  ggtitle("Scots Bay")

ggplot(data = subset(atDepth, Ground == "Scots Bay" & In_Box == "1"), aes(x=Year, y=StratTemp, group = Year, colour = Year)) + 
  geom_boxplot() +   
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(NA,1.7) +
  labs(x="Year", y = "Temperature Difference (C)", title = "Temperature Difference (Stratification) vs. Year")
```

```{r, results = "asis"}
atDepth1 = atDepth %>% 
  filter(Ground == "Scots Bay" & In_Box == "1") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = StratTemp, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Temperature Difference") + 
  xlab("Julian Day") +
  ylim(NA, 1.7) +
  ggtitle("Scots Bay"))
  cat("\n")
}
```

##### Stratified Salinity {.tabset .tabset-pills}

###### Total

```{r}
ggplot(data = subset(atDepth, Ground == "Scots Bay" & In_Box == "1"), aes(x = Julian, y = StratSalt, colour = Year)) + 
  geom_point() + 
  ylab("Salinity Difference") + 
  xlab("Julian Day") +
  ylim(c(0, 0.7)) +
  ggtitle("Scots Bay")

ggplot(data = subset(atDepth, Ground == "Scots Bay" & In_Box == "1"), aes(x=Year, y=StratSalt, group = Year, colour = Year)) + 
  geom_boxplot() + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(NA,0.75)
  labs(x="Year", y = "Salinity Difference (PSS)", title = "Salinity Difference (Stratification) vs. Year")
```

```{r, results = "asis"}
atDepth1 = atDepth %>% 
  filter(Ground == "Scots Bay" & In_Box == "1") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = StratSalt, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Salinity Difference") + 
  xlab("Julian Day") +
  ylim(NA, 0.7) +
  ggtitle("Scots Bay"))
  cat("\n")
}
```

#### German Bank {.tabset}

##### Sea Surface Temperatures (SST) {.tabset .tabset-pills}

###### Total

```{r out.width="30%", fig.show="hold"}
ggplot(data = subset(SST, Ground == "German Bank" & In_Box == "1"), aes(x = Julian, y = Temperature, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Sea Surface Temperature") + 
  xlab("Julian Day") +
  ggtitle("German Bank")

Summer = SST %>% 
  subset(Ground == "German Bank" & In_Box == "1" & Month == "8")

ggplot(data = Summer, aes(x=Year, y=Temperature, group = Year, colour = Year))+
  geom_boxplot() +
  ylab("Average Sea Surface Temperature") +
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(9.5,18) +
  ggtitle("August SST") 
  
ggplot(data = subset(SST, Ground == "German Bank" & In_Box == "1"), aes(x=Year, y=Temperature, group = Year, colour = Year)) + 
  geom_boxplot() + 
  facet_wrap(~Month) + 
  ylim(9.5, 18) + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  labs(x="Year", y = "Sea Surface Temperature (SST) (C)", title = "German Bank: Monthly SST vs. Year") +
  theme(axis.text.x = element_text(angle = 55))
```

```{r, results = "asis"}
SST1 = SST %>% 
  filter(Ground == "German Bank" & In_Box == "1") %>%
  arrange(Survey)

for(i in unique(SST1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(SST1, Year == i), aes(x = Julian, y = Temperature)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Sea Surface Temperature") + 
  xlab("Julian Day") +
  ylim(NA, 18) +
  ggtitle("German Bank"))
  cat("\n")
}
```

##### At Depth Temperatures (30m) {.tabset .tabset-pills}

###### Total

```{r out.width="30%", fig.show="hold", fig.align='center'}
ggplot(data = subset(atDepth, Ground == "German Bank" & In_Box == "1"), aes(x = Julian, y = Temperature, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Temperature at 30m Depth") + 
  xlab("Julian Day") +
  ggtitle("German Bank")

Summer = atDepth %>% 
  subset(Ground == "German Bank" & In_Box == "1" & Month == "8")

ggplot(data = Summer, aes(x=Year, y=Temperature, group = Year, colour = Year))+
  geom_boxplot() +
  ylab("Average Temperature at 30m Depth") +
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(9,14)+
  ggtitle("August At-Depth Temperature")

ggplot(data = subset(atDepth, Ground == "German Bank" & In_Box == "1"), aes(x=Year, y=Temperature, group = Year, colour = Year)) + 
  geom_boxplot() + 
  facet_wrap(~Month) + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  ylim(10,13.5) +
  labs(x="Year", y = "Temperature (C) at 30m Depth", title = "German Bank: Monthly 30m Temperature vs. Year") +
  theme(axis.text.x = element_text(angle = 55))
```

```{r, results = "asis", fig.align='center'}
atDepth1 = atDepth %>% 
  filter(Ground == "German Bank" & In_Box == "1") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = Temperature)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Temperature at 30m Depth") + 
  xlab("Julian Day") +
  ylim(NA, 14.5) +
  ggtitle("German Bank"))
  cat("\n")
}
```

##### Stratified Temperatures {.tabset .tabset-pills}

###### Total

```{r, fig.align='center'}
ggplot(data = subset(atDepth, Ground == "German Bank" & In_Box == "1"), aes(x = Julian, y = StratTemp, colour = Year)) + 
  geom_point() + 
  ylab("Temperature Difference") + 
  xlab("Julian Day") + 
  ylim(c(0, 8)) +
  ggtitle("German Bank")

ggplot(data = subset(atDepth, Ground == "German Bank" & In_Box == "1"), aes(x=Year, y=StratTemp, group = Year, colour = Year)) + 
  geom_boxplot() + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(NA, 6.5)+
  labs(x="Year", y = "Temperature Difference (C)", title = "Temperature Difference (Stratification) vs. Year")
```

```{r, results = "asis", fig.align='center'}
atDepth1 = atDepth %>% 
  filter(Ground == "German Bank" & In_Box == "1") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = StratTemp, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Temperature Difference") + 
  xlab("Julian Day") +
  ylim(c(0, 8)) +
  ggtitle("German Bank"))
  cat("\n")
}
```

##### Stratified Salinity {.tabset .tabset-pills}

###### Total

```{r, fig.align='center'}
ggplot(data = subset(atDepth, Ground == "German Bank" & In_Box == "1"), aes(x = Julian, y = StratSalt, colour = Year)) + 
  geom_point() + 
  ylab("Salinity Difference") + 
  xlab("Julian Day") + 
  ylim(c(0, 1.8)) +
  ggtitle("German Bank")

ggplot(data = subset(atDepth, Ground == "German Bank" & In_Box == "1"), aes(x=Year, y=StratSalt, group = Year, colour = Year)) + 
  geom_boxplot() + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  ylim(NA,1.6) +
  labs(x="Year", y = "Salinity Difference (PSS)", title = "Salinity Difference (Stratification) vs. Year")
```

```{r, results = "asis", fig.align='center'}
atDepth1 = atDepth %>% 
  filter(Ground == "German Bank" & In_Box == "1") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = StratSalt, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Salinity Difference") + 
  xlab("Julian Day") +
  ylim(c(0, 1.8)) +
  ggtitle("German Bank"))
  cat("\n")
}
```

### All CTD Data (incl. Out-Box) {.tabset}

#### Scots Bay {.tabset}

##### Sea Surface Temperatures (SST) {.tabset .tabset-pills}

###### Total

```{r out.width="30%", fig.show="hold"}
ggplot(data = subset(SST, Ground == "Scots Bay"), aes(x = Julian, y = Temperature, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Sea Surface Temperature") +
  xlab("Julian Day") +
  ggtitle("Scots Bay")

Summer = SST %>% 
  subset(Ground == "Scots Bay" & Month == "8")

ggplot(data = Summer, aes(x=Year, y=Temperature, group = Year, colour = Year))+
  geom_boxplot() +
  ylab("Average Sea Surface Temperature") +
  ggtitle("August SST") +
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(8.5,16.5)

ggplot(data = subset(SST, Ground == "Scots Bay"), aes(x=Year, y=Temperature, group = Year, colour = Year)) +
  geom_boxplot() + 
  facet_wrap(~Month) + 
  ylim(7.5, 15.5) + 
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  labs(x="Year", y = "Sea Surface Temperature (SST) (C)", title = "Scots Bay: Monthly SST vs. Year") +
  theme(axis.text.x = element_text(angle = 55))
```

```{r, results = "asis"}
SST1 = SST %>% 
  filter(Ground == "Scots Bay") %>%
  arrange(Survey)

for(i in unique(SST1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(SST1, Year == i), aes(x = Julian, y = Temperature)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Sea Surface Temperature") +
  xlab("Julian Day") +
  ylim(NA, 16) +
  ggtitle("Scots Bay"))
  cat("\n")
}
```

##### At Depth Temperatures (30m) {.tabset .tabset-pills}

###### Total

```{r out.width="30%", fig.show="hold"}
ggplot(data = subset(atDepth, Ground == "Scots Bay"), aes(x = Julian, y = Temperature, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Temperature at 30m Depth") + 
  xlab("Julian Day") + 
  ggtitle("Scots Bay")

Summer = atDepth %>% 
  subset(Ground == "Scots Bay" & Month == "8")

ggplot(data = Summer, aes(x=Year, y=Temperature, group = Year, colour = Year))+
  geom_boxplot() +
  ylab("Average Temperature at 30m Depth") +
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(9,15) +
  ggtitle("August At-Depth Temperature")

ggplot(data = subset(atDepth, Ground == "Scots Bay"), aes(x=Year, y=Temperature, group = Year, colour = Year)) + 
  geom_boxplot() + 
  facet_wrap(~Month) + 
  ylim(7.5, 14.5) + 
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  labs(x="Year", y = "Temperature (C) at 30m Depth", title = "Scots Bay: Monthly 30m Temperature vs. Year") +
  theme(axis.text.x = element_text(angle = 55))
```

```{r, results = "asis"}
atDepth1 = atDepth %>% 
  filter(Ground == "Scots Bay") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = Temperature)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Temperature at 30m Depth") +
  xlab("Julian Day") +
  ylim(NA, 16) +
  ggtitle("Scots Bay"))
  cat("\n")
}
```

##### Stratified Temperatures {.tabset .tabset-pills}

###### Total

```{r}
ggplot(data = subset(atDepth, Ground == "Scots Bay"), aes(x = Julian, y = StratTemp, colour = Year)) + 
  geom_point() + 
  ylab("Temperature Difference") + 
  xlab("Julian Day") + 
  ylim(NA, 1.7) +
  ggtitle("Scots Bay")

ggplot(data = subset(atDepth, Ground == "Scots Bay"), aes(x=Year, y=StratTemp, group = Year, colour = Year)) + 
  geom_boxplot() +   
  stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(NA,1.7) +
  labs(x="Year", y = "Temperature Difference (C)", title = "Temperature Difference (Stratification) vs. Year")
```

```{r, results = "asis"}
atDepth1 = atDepth %>% 
  filter(Ground == "Scots Bay") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = StratTemp, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Temperature Difference") + 
  xlab("Julian Day") +
  ylim(NA, 1.7) +
  ggtitle("Scots Bay"))
  cat("\n")
}
```

##### Stratified Salinity {.tabset .tabset-pills}

###### Total

```{r}
ggplot(data = subset(atDepth, Ground == "Scots Bay"), aes(x = Julian, y = StratSalt, colour = Year)) + 
  geom_point() + 
  ylab("Salinity Difference") + 
  xlab("Julian Day") +
  ylim(c(0, 0.7)) +
  ggtitle("Scots Bay")

ggplot(data = subset(atDepth, Ground == "Scots Bay"), aes(x=Year, y=StratSalt, group = Year, colour = Year)) + 
  geom_boxplot() + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(NA,0.75) +
  labs(x="Year", y = "Salinity Difference (PSS)", title = "Salinity Difference (Stratification) vs. Year")
```

```{r, results = "asis"}
atDepth1 = atDepth %>% 
  filter(Ground == "Scots Bay") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = StratSalt, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Salinity Difference") + 
  xlab("Julian Day") +
  ylim(NA, 0.7) +
  ggtitle("Scots Bay"))
  cat("\n")
}
```

#### German Bank {.tabset}

##### Sea Surface Temperatures (SST) {.tabset .tabset-pills}

###### Total

```{r out.width="30%", fig.show="hold"}
ggplot(data = subset(SST, Ground == "German Bank"), aes(x = Julian, y = Temperature, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Sea Surface Temperature") + 
  xlab("Julian Day") +
  ggtitle("German Bank")

Summer = SST %>% 
  subset(Ground == "German Bank" & Month == "8")

ggplot(data = Summer, aes(x=Year, y=Temperature, group = Year, colour = Year))+
  geom_boxplot() +
  ylab("Average Sea Surface Temperature") +
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(9.5,18) +
  ggtitle("August SST") 
  
ggplot(data = subset(SST, Ground == "German Bank"), aes(x=Year, y=Temperature, group = Year, colour = Year)) + 
  geom_boxplot() + 
  facet_wrap(~Month) + 
  ylim(9.5, 18) + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  labs(x="Year", y = "Sea Surface Temperature (SST) (C)", title = "German Bank: Monthly SST vs. Year") +
  theme(axis.text.x = element_text(angle = 55))
```

```{r, results = "asis"}
SST1 = SST %>% 
  filter(Ground == "German Bank") %>%
  arrange(Survey)

for(i in unique(SST1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(SST1, Year == i), aes(x = Julian, y = Temperature)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Sea Surface Temperature") + 
  xlab("Julian Day") +
  ylim(NA, 18) +
  ggtitle("German Bank"))
  cat("\n")
}
```

##### At Depth Temperatures (30m) {.tabset .tabset-pills}

###### Total

```{r out.width="30%", fig.show="hold", fig.align='center'}
ggplot(data = subset(atDepth, Ground == "German Bank"), aes(x = Julian, y = Temperature, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Temperature at 30m Depth") + 
  xlab("Julian Day") +
  ggtitle("German Bank")

Summer = atDepth %>% 
  subset(Ground == "German Bank" & Month == "8")

ggplot(data = Summer, aes(x=Year, y=Temperature, group = Year, colour = Year))+
  geom_boxplot() +
  ylab("Average Temperature at 30m Depth") +
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(9,14)+
  ggtitle("August At-Depth Temperature")

ggplot(data = subset(atDepth, Ground == "German Bank"), aes(x=Year, y=Temperature, group = Year, colour = Year)) + 
  geom_boxplot() + 
  facet_wrap(~Month) + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  ylim(10,13.5) +
  labs(x="Year", y = "Temperature (C) at 30m Depth", title = "German Bank: Monthly 30m Temperature vs. Year") +
  theme(axis.text.x = element_text(angle = 55))
```

```{r, results = "asis", fig.align='center'}
atDepth1 = atDepth %>% 
  filter(Ground == "German Bank") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = Temperature)) + 
  geom_point() + 
  geom_line() +
  ylab("Average Temperature at 30m Depth") + 
  xlab("Julian Day") +
  ylim(NA, 14.5) +
  ggtitle("German Bank"))
  cat("\n")
}
```

##### Stratified Temperatures {.tabset .tabset-pills}

###### Total

```{r, fig.align='center'}
ggplot(data = subset(atDepth, Ground == "German Bank"), aes(x = Julian, y = StratTemp, colour = Year)) + 
  geom_point() + 
  ylab("Temperature Difference") + 
  xlab("Julian Day") + 
  ylim(c(0, 8)) +
  ggtitle("German Bank")

ggplot(data = subset(atDepth, Ground == "German Bank"), aes(x=Year, y=StratTemp, group = Year, colour = Year)) + 
  geom_boxplot() + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -0.5) +
  ylim(NA, 6.5)+
  labs(x="Year", y = "Temperature Difference (C)", title = "Temperature Difference (Stratification) vs. Year")
```

```{r, results = "asis", fig.align='center'}
atDepth1 = atDepth %>% 
  filter(Ground == "German Bank") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = StratTemp, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Temperature Difference") + 
  xlab("Julian Day") +
  ylim(c(0, 8)) +
  ggtitle("German Bank"))
  cat("\n")
}
```

##### Stratified Salinity {.tabset .tabset-pills}

###### Total

```{r, fig.align='center'}
ggplot(data = subset(atDepth, Ground == "German Bank"), aes(x = Julian, y = StratSalt, colour = Year)) + 
  geom_point() + 
  ylab("Salinity Difference") + 
  xlab("Julian Day") + 
  ylim(c(0, 1.8)) +
  ggtitle("German Bank")

ggplot(data = subset(atDepth, Ground == "German Bank"), aes(x=Year, y=StratSalt, group = Year, colour = Year)) + 
  geom_boxplot() + 
    stat_summary(fun.y = median, fun.ymax = length,
               geom = "text", aes(label = ..ymax..), vjust = -1) +
  ylim(NA,1.6) +
  labs(x="Year", y = "Salinity Difference (PSS)", title = "Salinity Difference (Stratification) vs. Year")
```

```{r, results = "asis", fig.align='center'}
atDepth1 = atDepth %>% 
  filter(Ground == "German Bank") %>%
  arrange(Survey)

for(i in unique(atDepth1$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
print(ggplot(data = subset(atDepth1, Year == i), aes(x = Julian, y = StratSalt, colour = Year)) + 
  geom_point() + 
  geom_line() +
  ylab("Salinity Difference") + 
  xlab("Julian Day") +
  ylim(c(0, 1.8)) +
  ggtitle("German Bank"))
  cat("\n")
}
```

#### Maps {.tabset}

##### Scots Bay

```{r message=FALSE, warning=FALSE, fig.align='center'}
CP <- as(extent(-65.5, -64.5, 45, 45.5), "SpatialPolygons")
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)

ggplot(data = subset(CTD, Ground == "Scots Bay"), aes(x=Lon, y=Lat)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polySB_main,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBplankton,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyNorthern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polyEastern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_point(aes(fill = Year), pch=21, size = 2) +
  coord_map() + 
  labs(x=NULL, y=NULL)
```

##### German Bank

```{r message=FALSE, warning=FALSE, fig.align='center'}
CP <- as(extent(-66.5, -65.5, 43, 44), "SpatialPolygons")
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)

ggplot(data = subset(CTD, Ground == "German Bank" & In_Box == "1"), aes(x=Lon, y=Lat)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_point(aes(fill = Year), pch=21, size = 2) +
  coord_map() + 
  labs(x=NULL, y=NULL)
```

##### All Casts

```{r echo=FALSE, fig.height=9, fig.width=15, message=FALSE, warning=FALSE}
#Reset spatial extent back to full view
CP <- as(extent(-69, -63, 42, 45.5), "SpatialPolygons")
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)

ggplot(data = CTD, aes(x=Lon, y=Lat)) + 
 geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") + 
 geom_polygon(data=out,aes(x=long, y=lat, group=group),fill='burlywood4',col='black') +
 geom_point(pch=21, size = 2, fill = "White")+ ggtitle("CTD Cast Locations") + 
 labs(x=NULL, y=NULL) + 
 coord_map() + 
 theme(panel.background = element_rect(fill = "grey68"))
```

## Larval Project {.tabset}

### Scots Bay {.tabset}
#### Length Data {.tabset .tabset-pills}

##### Total 

```{r, results = "asis", fig.align='center'}
Larval1 <- subset.data.frame(Larval, Ground == "SB")

Larval1 %>% ggplot(aes(y=LengthAdjustment, x=Survey.No, colour = Year)) + 
  geom_point(position = "jitter") +
  labs(y="Length (mm)", x="Survey Number")

ggplot(Larval1, aes(Year, LengthAdjustment, colour = Year)) + 
  geom_boxplot() +
  labs(y="Length (mm)")

Table = Larval1 %>%
  group_by(Year) %>%
  summarize(MinLength = min(LengthAdjustment),
            MaxLength = max(LengthAdjustment),
            AvgLength = mean(LengthAdjustment),
            AvgSD = mean(SD),
            Abundance = n()) %>%
  mutate_if(is.numeric, format, digits=2)

kbl(Table, col.names=c("Year", "Min Length (mm)", "Max Length (mm)", "Mean Length (mm)", "+/- SD (mm)", "Abundance"), align = "c") %>%
  kable_paper("striped", full_width = F)
```


```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
# In histogram, count is the number of individuals that fall into that length category over the whole year. It is split by colour into each individual survey. Each length category is therefore split up by number of individuals per survey.
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 <- subset.data.frame(Larval, Ground == "SB")
Larval1 = Larval1 %>% filter(Year == i)

Larval1 %>% ggplot(aes(y=LengthAdjustment, x=Survey.No, colour = id)) + 
  geom_point(position = "jitter") +
  labs(y="Length (mm)", x="Survey Number")

print(ggplot(data = subset(Larval1, Year == i), aes(x = Survey.No, y = LengthAdjustment, colour = id)) + 
  geom_point(position = "jitter") +
  ylab("Length (mm)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$LengthAdjustment))) + 
  scale_x_discrete(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "German Bank")))
  cat("\n")
  
print(ggplot(data = Larval1, (aes(LengthAdjustment, fill = id))) + 
  geom_histogram(binwidth=0.5, colour = "white") + 
  theme(panel.background = element_rect(fill = "white", colour = "grey50")) + 
  labs(x = "Length (mm)", y="Count"))
  cat("\n")
      
#print(ggplot(data=Larval1, aes(LengthAdjustment, colour = Survey.No)) + 
#  geom_freqpoly(bins=100, linewidth = 1) +
#  labs(y="Count", x="Length (mm)"))
#  cat("\n")
  
  Table = Larval1 %>% 
  group_by(Survey.No) %>%
  summarize(AvgLength = mean(LengthAdjustment),
            AvgSD = mean(SD),
            Abundance = n()) %>%
  mutate_if(is.numeric, format, digits=2)

print(kbl(Table, col.names=c("Survey #", "Mean Length (mm)", "+/- SD (mm)", "Abundance"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Category Data {.tabset .tabset-pills}
##### Total


```{r echo=FALSE, fig.align='center'}

Larval2 <- subset.data.frame(Larval, Ground == "SB")

ggplot(Larval2, aes(Julian, LengthAdjustment, colour = Year)) + 
  geom_jitter(size = 1.25, width = 3) + 
  geom_hline(yintercept = 8, linetype = "longdash", size =1, colour = "red")  + 
  geom_hline(yintercept = 12, linetype = "longdash", size =1, colour = "blue")  + 
  geom_hline(yintercept = 17, linetype = "longdash", size =1, colour = "forestgreen") + 
  geom_hline(yintercept = 27, linetype = "longdash", size =1, colour = "grey70") +
  labs(x= "Julian Date of Collection", y = "Length (mm)") 

TotalCategories <- Larval2 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  mutate(Length = ifelse(category==1, "<8", 
                  ifelse(category==2, "8-12",
                  ifelse(category==3, "13-17",
                  ifelse(category==4, "18-27",
                  ifelse(category==5, ">28", NA)))))) %>%
  relocate(Length, .after = category) %>%
    mutate(Age = ifelse(category==1, "<2 weeks", 
                  ifelse(category==2, "2-5 weeks",
                  ifelse(category==3, "5-8 weeks",
                  ifelse(category==4, "8-14 weeks",
                  ifelse(category==5, ">14 weeks", NA)))))) %>%
  relocate(Age, .after = Length)

kbl(TotalCategories, col.names=c("Category", "Length (mm)", "Age", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 <- subset.data.frame(Larval, Ground == "SB")
Larval1 = Larval %>% filter(Year == i)
 
print(ggplot(Larval1, aes(Julian, LengthAdjustment)) + 
  geom_jitter(size = 2) + 
  geom_hline(yintercept = 8, linetype = "longdash", size =1, colour = "red")  + 
  geom_hline(yintercept = 12, linetype = "longdash", size =1, colour = "blue")  + 
  geom_hline(yintercept = 17, linetype = "longdash", size =1, colour = "forestgreen") + 
  geom_hline(yintercept = 27, linetype = "longdash", size =1, colour = "grey70") +
  labs(x= "Julian Date of Collection", y = "Length (mm)"))
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Mapped Data {.tabset .tabset-pills}

```{r message=FALSE, warning=FALSE}
CP <- as(extent(-66.5, -64.5, 44.5, 45.5), "SpatialPolygons") #set boundaries for Scots Bay before plotting
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)
```

##### Total

```{r echo=FALSE, fig.align='center'}

Larval2 <- subset(Larval, Ground == 'SB')

ggplot(Larval2, aes(x=Lon1, y=Lat1)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polySB_main,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBplankton,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyNorthern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polyEastern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) + 
  geom_point(data=Larval2, aes(fill = Year, size = Abundance), pch=21, alpha = 0.6) +
  labs(x=NULL, y=NULL) + 
  coord_map()

TotalCategories <- Larval2 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  mutate(Length = ifelse(category==1, "<8", 
                  ifelse(category==2, "8-12",
                  ifelse(category==3, "12-17",
                  ifelse(category==4, "17-27",
                  ifelse(category==5, ">27", NA)))))) %>%
  relocate(Length, .after = category)

kbl(TotalCategories, col.names=c("Category", "Length (mm)", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval %>% filter(Year == i) %>% filter(Ground == "SB")
 
print(ggplot(Larval1, aes(x=Lon1, y=Lat1)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polySB_main,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBplankton,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=SBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyNorthern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polyEastern,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) + 
  geom_point(data=Larval1, aes(fill = category, size = Abundance), pch=21, alpha = 0.6) +
  labs(x=NULL, y=NULL) + 
  coord_map())
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Depth Data {.tabset .tabset-pills}
##### Total

```{r echo=FALSE, fig.align='center'}
Larval %>% 
  ggplot(aes(LengthAdjustment, AvgTowDepth, colour = category)) + 
  geom_jitter(height = 0.25) + 
  scale_y_reverse() +
  labs(x = "Length (mm)", y = "Average Tow Depth (m)", colour = "Category")

TotalCategories <- Larval %>%
  group_by(category) %>%
  summarize(n = n(),
            MeanDepth = mean(AvgTowDepth, na.rm = TRUE)) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  relocate(MeanDepth, .after= Percentage)

kbl(TotalCategories, col.names=c("Category", "Abundance", "%", "Avg Tow Depth (m)"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval %>% filter(Year == i)
 
print(ggplot(data=Larval1, (aes(LengthAdjustment, AvgTowDepth, colour = category))) + 
  geom_jitter(height = 0.25) + 
  scale_y_reverse() +
  labs(x = "Length (mm)", y = "Average Tow Depth (m)", colour = "Category"))
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  summarize(n = n(),
            MeanDepth = mean(AvgTowDepth, na.rm = TRUE)) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  relocate(MeanDepth, .after= Percentage)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%", "Avg Tow Depth (m)"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Spawning Modes {.tabset .tabset-pills}

##### Total

Growth applied to compare spawning modes.

```{r, fig.align='center'}

Larval1 = LarvalSum %>% filter(Ground == "SB")

print(ggplot(Larval1, aes(x = Survey.No, y = Density, colour = Year)) + 
  geom_point() + 
  ylab("Density (Abundance/Volume)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$Density))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("Larval Density "))

print(ggplot(Larval1, aes(x = Survey.No, y = Abundance, colour = Year)) + 
  geom_point() + 
  ylab("Abundance (Count/Tow)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$Abundance))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("Larval Abundance"))

print(ggplot(Larval1, aes(x = Survey.No, y = AdjustedMeanAgeInDays, colour = Year)) + 
  geom_point() + 
  ylab("Mean Age (days)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$AdjustedMeanAgeInDays))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("Mean Larval Age of Each Individual Tow"))

```


```{r, results='asis', fig.align='center'}
 
for(i in unique(Larval$Year)) {
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval %>% filter(Ground == "SB")
Larval1 = Larval1 %>% filter(Year == i)

Larval1$MonthDay <- format(Larval1$Date, "%m-%d")

  
print(ggplot(data = subset(Larval1, Year == i), aes(x = as.numeric(Survey.No), y = Density, colour = MonthDay)) + 
  geom_point() + 
  ylab("Density (Abundance/Volume)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$Density))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Larval Density ")))
  cat("\n")

print(ggplot(Larval1, aes(x = as.numeric(Survey.No), y = Abundance, colour = MonthDay)) + 
  geom_point() + 
  ylab("Abundance (Larvae/Tow)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$Abundance))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Larval Abundance ")))
  cat("\n")

print(ggplot(Larval1, aes(x = as.numeric(Survey.No), y = AdjustedMeanAgeInDays, colour = MonthDay)) + 
  geom_point() + 
  ylab("Mean Age (days)") + 
  xlab("Survey Number") +
  xlim(0, 10) + 
  scale_y_continuous(limits = c(0, max(Larval1$AdjustedMeanAgeInDays))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, " Mean Larval Age of Each Individual Tow")))
  cat("\n")
}
```

### German Bank {.tabset}
#### Length Data {.tabset .tabset-pills}

##### Total

```{r echo=FALSE, fig.align='center'}

Larval = Larval %>% filter(Ground == "GB")

Larval %>% ggplot(aes(y=LengthAdjustment, x=Survey.No, colour = Year)) + 
  geom_point(position = "jitter") +
  labs(y="Length (mm)", x="Survey Number")

ggplot(Larval, aes(Year, LengthAdjustment, colour = Year)) + 
  geom_boxplot() +
  labs(y="Length (mm)")

Table = Larval %>%
  group_by(Year) %>%
  summarize(MinLength = min(LengthAdjustment),
            MaxLength = max(LengthAdjustment),
            AvgLength = mean(LengthAdjustment),
            AvgSD = mean(SD),
            Abundance = n()) %>%
  mutate_if(is.numeric, format, digits=2)

kbl(Table, col.names=c("Year", "Min Length (mm)", "Max Length (mm)", "Mean Length (mm)", "+/- SD (mm)", "Abundance"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}

Larval1 = Larval %>% filter(Ground == "GB")

for(i in unique(Larval$Year)) {
  
# In histogram, count is the number of individuals that fall into that length category over the whole year. It is split by colour into each individual survey. Each length category is therefore split up by number of individuals per survey.
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval1 %>% filter(Year == i)

Larval1 %>% ggplot(aes(y=LengthAdjustment, x=Survey.No, colour = id)) + 
  geom_point(position = "jitter") +
  labs(y="Length (mm)", x="Survey Number")

print(ggplot(data = subset(Larval1, Year == i), aes(x = Survey.No, y = LengthAdjustment, colour = id)) + 
  geom_point(position = "jitter") +
  ylab("Length (mm)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$LengthAdjustment))) + 
  scale_x_discrete(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "German Bank")))
  cat("\n")
 
print(ggplot(data = Larval1, (aes(LengthAdjustment, fill = id))) + 
  geom_histogram(binwidth=0.5, colour = "white") + 
  theme(panel.background = element_rect(fill = "white", colour = "grey50")) + 
  labs(x = "Length (mm)", y="Count"))
  cat("\n")
  
#print(ggplot(data=Larval1, aes(LengthAdjustment, colour = survey)) + 
#  geom_freqpoly(bins=100, linewidth = 1) +
#  labs(y="Count", x="Length (mm)"))
#  cat("\n")
  
  Table = Larval1 %>% 
  group_by(Survey.No) %>%
  summarize(AvgLength = mean(LengthAdjustment),
            AvgSD = mean(SD),
            Abundance = n()) %>%
  mutate_if(is.numeric, format, digits=2)

print(kbl(Table, col.names=c("Survey #", "Mean Length (mm)", "+/- SD (mm)", "Abundance"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Category Data {.tabset .tabset-pills}
##### Total


```{r echo=FALSE, fig.align='center'}
ggplot(Larval, aes(Julian, LengthAdjustment, colour = Year)) + 
  geom_jitter(size = 2) + 
  geom_hline(yintercept = 8, linetype = "longdash", size =1, colour = "red")  + 
  geom_hline(yintercept = 12, linetype = "longdash", size =1, colour = "blue")  + 
  geom_hline(yintercept = 17, linetype = "longdash", size =1, colour = "forestgreen") + 
  geom_hline(yintercept = 27, linetype = "longdash", size =1, colour = "grey70") +
  labs(x= "Julian Date of Collection", y = "Length (mm)") 

TotalCategories <- Larval %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  mutate(Length = ifelse(category==1, "<8", 
                  ifelse(category==2, "8-12",
                  ifelse(category==3, "12-17",
                  ifelse(category==4, "17-27",
                  ifelse(category==5, ">27", NA)))))) %>%
  relocate(Length, .after = category)

kbl(TotalCategories, col.names=c("Category", "Length (mm)", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval %>% filter(Year == i)
 
print(ggplot(Larval1, aes(Julian, LengthAdjustment)) + 
  geom_jitter(size = 2) + 
  geom_hline(yintercept = 8, linetype = "longdash", size =1, colour = "red")  + 
  geom_hline(yintercept = 12, linetype = "longdash", size =1, colour = "blue")  + 
  geom_hline(yintercept = 17, linetype = "longdash", size =1, colour = "forestgreen") + 
  geom_hline(yintercept = 27, linetype = "longdash", size =1, colour = "grey70") +
  labs(x= "Julian Date of Collection", y = "Length (mm)"))
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Mapped Data {.tabset .tabset-pills}

```{r message=FALSE, warning=FALSE}
CP <- as(extent(-66.5, -65.5, 43, 44), "SpatialPolygons") #set boundaries for German Bank before plotting
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)
```

##### Total

```{r echo=FALSE, fig.align='center'}

Larval2 <- subset(Larval, Ground == 'GB')

ggplot(Larval2, aes(x=Lon1, y=Lat1)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_point(data=Larval2, aes(fill = Year, size = Abundance), pch=21, alpha = 0.6) +
  labs(x=NULL, y=NULL) + 
  coord_map()

TotalCategories <- Larval2 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  mutate(Length = ifelse(category==1, "<8", 
                  ifelse(category==2, "8-12",
                  ifelse(category==3, "12-17",
                  ifelse(category==4, "17-27",
                  ifelse(category==5, ">27", NA)))))) %>%
  relocate(Length, .after = category)

kbl(TotalCategories, col.names=c("Category", "Length (mm)", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F)
```



```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval %>% filter(Year == i) %>% filter()
 
print(ggplot(Larval1, aes(x=Lon1, y=Lat1)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) + 
  geom_point(data=Larval1, aes(fill = category, size = Abundance), pch=21, alpha = 0.6) +
  labs(x=NULL, y=NULL) + 
  coord_map())
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Depth Data {.tabset .tabset-pills}
##### Total

```{r echo=FALSE, fig.align='center'}
Larval %>% 
  ggplot(aes(LengthAdjustment, AvgTowDepth, colour = category)) + 
  geom_point() + 
  scale_y_reverse() +
  labs(x = "Length (mm)", y = "Average Tow Depth (m)", colour = "Category")

TotalCategories <- Larval %>%
  group_by(category) %>%
  summarize(n = n(),
            MeanDepth = mean(AvgTowDepth, na.rm = TRUE)) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  relocate(MeanDepth, .after= Percentage)

kbl(TotalCategories, col.names=c("Category", "Abundance", "%", "Avg Tow Depth (m)"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval %>% filter(Year == i)
 
print(ggplot(data=Larval1, (aes(LengthAdjustment, AvgTowDepth, colour = category))) + 
  geom_point() + 
  scale_y_reverse() +
  labs(x = "Length (mm)", y = "Average Tow Depth (m)", colour = "Category"))
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  summarize(n = n(),
            MeanDepth = mean(AvgTowDepth, na.rm = TRUE)) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  relocate(MeanDepth, .after= Percentage)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%", "Avg Tow Depth (m)"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Spawning Modes {.tabset .tabset-pills}

##### Total

Growth applied to compare spawning modes.

```{r, fig.align='center'}

#Should x be Julian date and colour be survey number instead of year?
#Need to add in Larval summary table within compendium

GBLarvalSum = LarvalSum %>% filter(Ground == "GB")

#GBLarvalSum$Density[is.na(GBLarvalSum$Density)] = 0
#GBLarvalSum$Abundance[is.na(GBLarvalSum$Abundance)] = 0
#GBLarvalSum$AdjustedMeanAgeInDays[is.na(GBLarvalSum$AdjustedMeanAgeInDays)] = 0

print(ggplot(GBLarvalSum, aes(x = Survey.No, y = Density, colour = Year)) + 
  geom_point() + 
  ylab("Density (Abundance/Volume)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(GBLarvalSum$Density))) +
  scale_x_continuous(limits = c(1, 10), breaks = seq(1,10,1)) +
  ggtitle("Larval Density "))

print(ggplot(GBLarvalSum, aes(x = Survey.No, y = Abundance, colour = Year)) + 
  geom_point() + 
  ylab("Abundance (Larvae/Tow)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(GBLarvalSum$Abundance))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("Larval Abundance "))

print(ggplot(GBLarvalSum, aes(x = Survey.No, y = AdjustedMeanAgeInDays, colour = Year)) + 
  geom_point() + 
  ylab("Mean Larval Age (days)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(GBLarvalSum$AdjustedMeanAgeInDays))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("Mean Larval Age of Individual Tows"))

```


```{r, results='asis', fig.align='center'}
 
for(i in unique(Larval$Year)) {
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = LarvalSum %>% filter(Ground == "GB")
Larval1 = Larval1 %>% filter(Year == i)
#Larval1$Density[is.na(Larval1$Density)] <- 0
#Larval1$Abundance[is.na(Larval1$Abundance)] <- 0
#Larval1$AdjustedMeanAgeInDays[is.na(Larval1$AdjustedMeanAgeInDays)] <- 0

Larval1$MonthDay <- format(Larval1$Date, "%m-%d")

  
print(ggplot(data = subset(Larval1, Year == i), aes(x = as.numeric(Survey.No), y = Density, colour = MonthDay)) + 
  geom_point() + 
  ylab("Density (Abundance/Volume)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$Density))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Larval Density ")))
  cat("\n")

print(ggplot(Larval1, aes(x = as.numeric(Survey.No), y = Abundance, colour = MonthDay)) + 
  geom_point() + 
  ylab("Abundance (Larvae/Tow)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$Abundance))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Larval Abundance ")))
  cat("\n")

print(ggplot(Larval1, aes(x = as.numeric(Survey.No), y = AdjustedMeanAgeInDays, colour = MonthDay)) + 
  geom_point() + 
  ylab("Mean Age (days)") + 
  xlab("Survey Number") +
  xlim(0, 10) + 
  scale_y_continuous(limits = c(0, max(Larval1$AdjustedMeanAgeInDays))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Mean Larval Age in Days")))
  cat("\n")
}
```

### Seal Island {.tabset}
#### Length Data {.tabset .tabset-pills}

##### Total

```{r echo=FALSE, fig.align='center'}

Larval = LarvalSI

Larval %>% ggplot(aes(y=LengthAdjustment, x=Julian, colour = Year)) + 
  geom_point() +
  scale_x_continuous(labels = scales::label_number(1), limits = c(284, 288)) +
  labs(y="Length (mm)", x="Julian Date of Collection")

ggplot(Larval, aes(Year, LengthAdjustment, colour = Year)) + 
  geom_boxplot() +
  labs(y="Length (mm)")

Table = Larval %>%
  group_by(Year) %>%
  summarize(MinLength = min(LengthAdjustment),
            MaxLength = max(LengthAdjustment),
            AvgLength = mean(LengthAdjustment),
            AvgSD = mean(SD),
            Abundance = n()) %>%
  mutate_if(is.numeric, format, digits=2)

kbl(Table, col.names=c("Year", "Min Length (mm)", "Max Length (mm)", "Mean Length (mm)", "+/- SD (mm)", "Abundance"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
# In histogram, count is the number of individuals that fall into that length category over the whole year. It is split by colour into each individual survey. Each length category is therefore split up by number of individuals per survey.
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = LarvalSI %>% filter(Year == i)

Larval1 %>% ggplot(aes(y=LengthAdjustment, x=Survey.No, colour = id)) + 
  geom_point() +
  labs(y="Length (mm)", x="Survey Number")

print(ggplot(data = subset(Larval1, Year == i), aes(x = Survey.No, y = LengthAdjustment, colour = id)) + 
  geom_point(position = "jitter") +
  ylab("Length (mm)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(Larval1$LengthAdjustment))) + 
  scale_x_discrete(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Seal Island")))
  cat("\n")
 
print(ggplot(data = Larval1, (aes(LengthAdjustment, fill = id))) + 
  geom_histogram(binwidth=0.5, colour = "white") + 
  theme(panel.background = element_rect(fill = "white", colour = "grey50")) + 
  labs(x = "Length (mm)", y="Count"))
  cat("\n")
  
#print(ggplot(data=Larval1, aes(LengthAdjustment, colour = Survey.No)) + 
#  geom_freqpoly(bins=100, linewidth = 1) +
#  labs(y="Count", x="Length (mm)"))
#  cat("\n")
  
  Table = Larval1 %>% 
  group_by(Survey.No) %>%
  summarize(AvgLength = mean(LengthAdjustment),
            AvgSD = mean(SD),
            Abundance = n()) %>%
  mutate_if(is.numeric, format, digits=2)

print(kbl(Table, col.names=c("Survey #", "Mean Length (mm)", "+/- SD (mm)", "Abundance"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Category Data {.tabset .tabset-pills}
##### Total


```{r echo=FALSE, fig.align='center'}

ggplot(Larval, aes(Julian, LengthAdjustment, colour = Year)) + 
  geom_jitter(size = 2) + 
   scale_x_continuous(labels = scales::label_number(1), limits = c(284, 288)) +
  geom_hline(yintercept = 8, linetype = "longdash", size =1, colour = "red")  + 
  geom_hline(yintercept = 12, linetype = "longdash", size =1, colour = "blue")  + 
  geom_hline(yintercept = 17, linetype = "longdash", size =1, colour = "forestgreen") +
  geom_hline(yintercept = 27, linetype = "longdash", size =1, colour = "grey70") +
  labs(x= "Julian Date of Collection", y = "Length (mm)")

TotalCategories <- Larval %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  mutate(Length = ifelse(category==1, "<8", 
                  ifelse(category==2, "8-12",
                  ifelse(category==3, "12-17",
                  ifelse(category==4, "17-27",
                  ifelse(category==5, ">27", NA)))))) %>%
  relocate(Length, .after = category)

kbl(TotalCategories, col.names=c("Category", "Length (mm)", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = LarvalSI %>% filter(Year == i)
 
print(ggplot(Larval1, aes(Julian, LengthAdjustment)) + 
  geom_jitter(size = 2) + 
  scale_x_continuous(labels = scales::label_number(1), limits = c(284, 288)) +
  geom_hline(yintercept = 8, linetype = "longdash", size =1, colour = "red")  + 
  geom_hline(yintercept = 12, linetype = "longdash", size =1, colour = "blue")  + 
  geom_hline(yintercept = 17, linetype = "longdash", size =1, colour = "forestgreen") + 
  geom_hline(yintercept = 27, linetype = "longdash", size =1, colour = "grey70") +
  labs(x= "Julian Date of Collection", y = "Length (mm)"))
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Mapped Data {.tabset .tabset-pills}

```{r message=FALSE, warning=FALSE}
CP <- as(extent(-66.5, -65.5, 43, 44), "SpatialPolygons") #set boundaries for German Bank before plotting
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)
```

##### Total

```{r echo=FALSE, fig.align='center'}

Larval2 <- subset(Larval, Ground == 'SI')

ggplot(Larval2, aes(x=Lon1, y=Lat1)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_point(data=Larval2, aes(fill = Year, size = Abundance), pch=21, alpha = 0.6) +
  labs(x=NULL, y=NULL) + 
  coord_map()

TotalCategories <- Larval2 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  mutate(Length = ifelse(category==1, "<8", 
                  ifelse(category==2, "8-12",
                  ifelse(category==3, "12-17",
                  ifelse(category==4, "17-27",
                  ifelse(category==5, ">27", NA)))))) %>%
  relocate(Length, .after = category)

kbl(TotalCategories, col.names=c("Category", "Length (mm)", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F)
```



```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval %>% filter(Year == i) %>% filter()
 
print(ggplot(Larval1, aes(x=Lon1, y=Lat1)) + 
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +  
  geom_polygon(data=GBCTD,aes(x=X, y=Y, group=PID), colour = "black", fill = "white", linetype = 3) +
  geom_polygon(data=polyGB,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) +
  geom_polygon(data=polySI,aes(x=X, y=Y, group=PID), colour = "black", fill="white",linetype = 3) + 
  geom_point(data=Larval1, aes(fill = category, size = Abundance), pch=21, alpha = 0.6) +
  labs(x=NULL, y=NULL) + 
  coord_map())
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  dplyr::summarize(n = n()) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Depth Data {.tabset .tabset-pills}
##### Total

```{r echo=FALSE, fig.align='center'}
LarvalSI %>% 
  ggplot(aes(LengthAdjustment, AvgTowDepth, colour = category)) + 
  geom_point() + 
  scale_y_reverse() +
  labs(x = "Length (mm)", y = "Average Tow Depth (m)", colour = "Category")

TotalCategories <- LarvalSI %>%
  group_by(category) %>%
  summarize(n = n(),
            MeanDepth = mean(AvgTowDepth, na.rm = TRUE)) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  relocate(MeanDepth, .after= Percentage)

kbl(TotalCategories, col.names=c("Category", "Abundance", "%", "Avg Tow Depth (m)"), align = "c") %>%
  kable_paper("striped", full_width = F)
```

```{r, results = "asis", fig.align='center'}
for(i in unique(Larval$Year)) {
  
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

Larval1 = Larval %>% filter(Year == i)
 
print(ggplot(data=Larval1, (aes(LengthAdjustment, AvgTowDepth, colour = category))) + 
  geom_point() + 
  scale_y_reverse() +
  labs(x = "Length (mm)", y = "Average Tow Depth (m)", colour = "Category"))
  cat("\n")
  
  TotalCategories <- Larval1 %>%
  group_by(category) %>%
  summarize(n = n(),
            MeanDepth = mean(AvgTowDepth, na.rm = TRUE)) %>%
  mutate(Percentage = (n/sum(n))*100) %>%
  mutate_if(is.numeric, format, digits = 1) %>%
  relocate(MeanDepth, .after= Percentage)

print(kbl(TotalCategories, col.names=c("Category", "Abundance", "%", "Avg Tow Depth (m)"), align = "c") %>%
  kable_paper("striped", full_width = F))
  cat("\n")
}
```

#### Spawning Modes {.tabset .tabset-pills}

##### Total

Growth applied to compare spawning modes.

```{r, fig.align='center'}

LarvalSum = LarvalSum %>% filter(Ground == "SI")

print(ggplot(LarvalSum, aes(x = Survey.No, y = Density, colour = Year)) + 
  geom_point() + 
  ylab("Density (Abundance/Volume)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(LarvalSum$Density))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("Larval Density "))

print(ggplot(LarvalSum, aes(x = Survey.No, y = Abundance, colour = Year)) + 
  geom_point() + 
  ylab("Abundance (Larvae/Tow)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(LarvalSum$Abundance))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("Larval Abundance "))

print(ggplot(LarvalSum, aes(x = Survey.No, y = AdjustedMeanAgeInDays, colour = Year)) + 
  geom_point() + 
  ylab("Mean Age (days)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(LarvalSum$AdjustedMeanAgeInDays))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle("Mean Larval Age in Days"))

```


```{r, results='asis', fig.align='center'}
 
for(i in unique(Larval$Year)) {
  cat("\n")
  cat("#####", i, "\n")
  cat("\n")

LarvalSum = LarvalSum %>% filter(Year == i)
#LarvalSum$Density[is.na(LarvalSum$Density)] <- 0
#LarvalSum$Abundance[is.na(LarvalSum$Abundance)] <- 0
#LarvalSum$AdjustedMeanAgeInDays[is.na(LarvalSum$AdjustedMeanAgeInDays)] <- 0

LarvalSum$MonthDay <- format(LarvalSum$Date, "%m-%d")

  
print(ggplot(data = subset(LarvalSum, Year == i), aes(x = as.numeric(Survey.No), y = Density, colour = MonthDay)) + 
  geom_point() + 
  ylab("Density (Abundance/Volume)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(LarvalSum$Density))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Larval Density ")))
  cat("\n")

print(ggplot(LarvalSum, aes(x = as.numeric(Survey.No), y = Abundance, colour = MonthDay)) + 
  geom_point() + 
  ylab("Abundance (Larvae/Tow)") + 
  xlab("Survey Number") +
  scale_y_continuous(limits = c(0, max(LarvalSum$Abundance))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Larval Abundance ")))
  cat("\n")

print(ggplot(LarvalSum, aes(x = as.numeric(Survey.No), y = AdjustedMeanAgeInDays, colour = MonthDay)) + 
  geom_point() + 
  ylab("Mean Age (days)") + 
  xlab("Survey Number") +
  xlim(0, 10) + 
  scale_y_continuous(limits = c(0, max(LarvalSum$AdjustedMeanAgeInDays))) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  ggtitle(paste(i, "Mean Larval Age of Each Individual Tow")))
  cat("\n")
}
```

## Fat Project 

### Spatial Analysis {.tabset .tabset-pills}

#### By Ground {.tabset .tabset-pills}

##### Total

```{r}

can<-getData('GADM', country="CAN", level=1)
us = getData('GADM', country = "USA", level = 1)
can1 = rbind(can,us)
NBNS <- can1[can1@data$NAME_1%in%c("New Brunswick","Nova Scotia","Prince Edward Island","Newfoundland and Labrador","QuÃ©bec", "Maine", "New Hampshire", "Massachusetts", "Connecticut", "Rhode Island", "New York", "Vermont", "New Jersey"),]

CP <- as(extent(-73, -61, 40.5, 46), "SpatialPolygons")
proj4string(CP) <- CRS(proj4string(NBNS))
out <- crop(NBNS, CP, byid=TRUE)

pal <- colorNumeric(
  palette = "Reds",
  domain = FatData$Fat)

FatDataSum = FatData %>%
  group_by(Date, Lat, Lon) %>%
  summarize(Fat = mean(Fat))
leaflet(FatDataSum, options = leafletOptions(preferCanvas = TRUE)) %>% 
  addCircles(data = subset(FatDataSum, Lat > 40 & Lat < 47), color=~pal(Fat), popup = ~as.character(Fat)) %>%
  addProviderTiles(providers$CartoDB.Positron, options = providerTileOptions(updateWhenZooming = FALSE, updateWhenIdle = TRUE)) %>%
  clearBounds() %>%
  addLegend("bottomright", pal = pal, values = ~Fat,
    title = "Fat Percent (%)",
    labFormat = labelFormat(suffix = "%"),
    opacity = 1)

```

##### January {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 1)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")

}
```
  
##### February {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 2) 

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10))) 

cat("\n")
}
```

##### March {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 3)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}

```

##### April{.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 4)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}
```

##### May {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 5)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}
```

##### June{.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 6)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}

```

##### July{.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 7)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}
```

##### August{.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 8)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}

```

##### September{.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 9)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}
```

##### October{.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 10)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}
```

##### November{.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 11)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}
```

##### December {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center', fig.width = 14} 
for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 12)

print(FatData1 %>%
  ggplot(aes(x=Lon, y=Lat)) + 
  geom_polygon(data=polysT,aes(x=X, y=Y, group=Box, fill = Box), colour = "black") +
  geom_point(data=subset(FatData1, Lat < 46 & Lat > 40 & Year == i), aes(color=Fat)) +
  scale_color_viridis_c(direction=-1) +
  geom_polygon(data=out,aes(x=long, y=lat, group=group)) +
  coord_map() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 10), legend.text = element_text(size=10)))

  cat("\n")
}
```


#### By Latitude {.tabset .tabset-pills}

##### Total

```{r}
library(scales)


FatData %>%
  filter(!is.na(Lat)) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)")

```

##### January {.tabset .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 1) %>% filter(!is.na(Lat))


print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### February {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 2) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### March {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 3) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### April {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 4) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### May {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 5) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### June {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 6) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### July {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 7) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### August {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 8) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```


##### September {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 9) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### October {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 10) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### November {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 11) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}
```

##### December {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis", fig.align='center'}

for(i in unique(FatData$Year)) {
  
  cat("\n")
  cat("######", i, "\n")
  cat("\n")
  
FatData1 = FatData %>% filter(Month == 12) %>% filter(!is.na(Lat))

print(FatData1 %>%
  filter(Year == i) %>%
  mutate(Lat = format(round(Lat, 1), nsmall = 1)) %>%
ggplot(aes(x=Fat, y=Lat, group = Lat, fill = Lat)) +
  geom_density_ridges(rel_min_height = 0.01) +
  theme(legend.position = "none") +
  labs(y="Latitude", x="Fat Percentage (%)"))

cat("\n")

}

```


#### By Company {.tabset .tabset-pills}

##### Total

::: row
::: col-md-6
```{r echo=FALSE}
FatDataSum = FatData
FatData$Year = as.factor(FatData$Year)
ggplot(data=FatData, aes(x=Year, y=Fat)) +
  geom_boxplot() +
  labs(y="Fat Percent (%)")
```
:::

::: col-md-6
```{r echo=FALSE}
FatData %>%
  group_by(Year) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Year", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)
```
:::
:::

##### Connors {.tabset .tabset-fade .tabset-pills}

###### By Year
```{r echo=FALSE}

ggplot(data=subset(FatData, Supplier == "Connors"), aes(x=Year, y=Fat)) +
  geom_boxplot() +
  labs(y="Fat Percent (%)")

FatData %>%
  dplyr::filter(Supplier == "Connors") %>%
  group_by(Year) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Year", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)

```

###### By Month

```{r echo=FALSE}
ggplot(data=subset(FatData, Supplier == "Connors" & !is.na(Month)), aes(x=Month, y=Fat, group=Month)) +
  geom_boxplot() +
  scale_x_continuous(breaks = round(seq(min(FatData$Month, max(FatData$Month), by = 1), 12)) ) +
  labs(y="Fat Percent (%)")

FatData %>%
  dplyr::filter(Supplier == "Connors" & !is.na(Month)) %>%
  group_by(Month) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Month", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)

```

##### Comeaus {.tabset .tabset-fade .tabset-pills}

###### By Year
```{r echo=FALSE}

ggplot(data=subset(FatData, Supplier == "Comeaus"), aes(x=Year, y=Fat)) +
  geom_boxplot() +
  labs(y="Fat Percent (%)")

FatData %>%
  dplyr::filter(Supplier == "Comeaus") %>%
  group_by(Year) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Year", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)

```

###### By Month

```{r echo=FALSE}
ggplot(data=subset(FatData, Supplier == "Comeaus" & !is.na(Month)), aes(x=Month, y=Fat, group=Month)) +
  geom_boxplot() +
  scale_x_continuous(breaks = round(seq(min(FatData$Month, max(FatData$Month), by = 1), 12)) ) +
  labs(y="Fat Percent (%)")

FatData %>%
  dplyr::filter(Supplier == "Connors" & !is.na(Month)) %>%
  group_by(Month) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Month", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)

```

##### Scotia {.tabset .tabset-fade .tabset-pills}

###### By Year
```{r echo=FALSE}

ggplot(data=subset(FatData, Supplier == "Scotia"), aes(x=Year, y=Fat)) +
  geom_boxplot() +
  labs(y="Fat Percent (%)")

FatData %>%
  dplyr::filter(Supplier == "Scotia") %>%
  group_by(Year) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Year", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)

```

###### By Month 

```{r echo=FALSE}
ggplot(data=subset(FatData, Supplier == "Comeaus" & !is.na(Month)), aes(x=Month, y=Fat, group=Month)) +
  geom_boxplot() +
  scale_x_continuous(breaks = round(seq(min(FatData$Month, max(FatData$Month), by = 1), 12)) ) +
  labs(y="Fat Percent (%)")

FatData %>%
  dplyr::filter(Supplier == "Connors" & !is.na(Month)) %>%
  group_by(Month) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Month", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)

```

##### Maine {.tabset .tabset-fade .tabset-pills}

###### By Year


```{r echo=FALSE}

ggplot(data=subset(FatData, Supplier == "Maine"), aes(x=Year, y=Fat)) +
  geom_boxplot() +
  labs(y="Fat Percent (%)")

FatData %>%
  dplyr::filter(Supplier == "Maine") %>%
  group_by(Year) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Year", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)

```

###### By Month 


```{r echo=FALSE}
ggplot(data=subset(FatData, Supplier == "Comeaus" & !is.na(Month)), aes(x=Month, y=Fat, group=Month)) +
  geom_boxplot() +
  scale_x_continuous(breaks = round(seq(min(FatData$Month, max(FatData$Month), by = 1), 12)) ) +
  labs(y="Fat Percent (%)")

FatData %>%
  dplyr::filter(Supplier == "Connors" & !is.na(Month)) %>%
  group_by(Month) %>%
  summarize(FatMean = mean(Fat)) %>%
  kbl(col.names = c("Month", "Avg Fat (%)")) %>%
  kable_paper("striped", full_width = F)

```


#### Weight At Age {.tabset .tabset-fade .tabset-pills}

::: row
::: col-md-6
```{r echo=FALSE}
FatDataSum = FatDataSum %>% 
  group_by(Year) %>%
  summarize(WAA = mean(WAA), Fat = mean(Fat))

p1 = ggplot(FatDataSum, aes(x=Year)) + 
  geom_line(aes(y=Fat)) +
  labs(y="Fat Percentage (%)")

p2 = ggplot(FatDataSum, aes(x=Year)) +
  geom_line(aes(y=WAA)) +
  labs(y="Average Weight At Age (g)")

library(patchwork)
p1+p2
```
:::

::: col-md-6
```{r echo=FALSE}
FatDataSum %>%
  kbl(col.names = c("Year", "Avg Wt at Age (g)", "Fat (%)")) %>%
  kable_paper("striped", full_width = T)
```
:::
:::